#!/bin/sh

# ==================================================
# IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿ - å®Œæ•´ä¸€é”®å®‰è£…è„šæœ¬
# ç‰ˆæœ¬: 5.0
# ä¿®å¤äº†æ‰€æœ‰å·²çŸ¥é—®é¢˜ï¼Œæä¾›å®Œæ•´åŠŸèƒ½
# ==================================================

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# é…ç½®å˜é‡
WEB_DIR="/www/iptv"
CGI_DIR="/www/cgi-bin"
CONFIG_DIR="/etc/iptv_discovery"
LOG_DIR="/var/log/iptv_discovery"
SCRIPT_DIR="/usr/bin"

# æ—¥å¿—å‡½æ•°
log() { echo -e "${GREEN}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') $1"; }
error() { echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') $1"; exit 1; }
step() { echo -e "${BLUE}[STEP]${NC} $1"; }

# æ˜¾ç¤ºæ¨ªå¹…
show_banner() {
    echo -e "${BLUE}"
    cat << "BANNER"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿ v5.0             â•‘
â•‘                                              â•‘
â•‘    ğŸ¬ æ™ºèƒ½ç›‘æ§   ğŸ“Š å®æ—¶åˆ†æ   ğŸŒ ç½‘é¡µç®¡ç†   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BANNER
    echo -e "${NC}"
    echo "åŠŸèƒ½ç‰¹æ€§:"
    echo "  âœ“ å®Œæ•´çš„Webç®¡ç†ç•Œé¢"
    echo "  âœ“ å®æ—¶æµé‡ç›‘æ§å’Œåˆ†æ"
    echo "  âœ“ è‡ªåŠ¨é¢‘é“å‘ç°å’Œåˆ†ç±»"
    echo "  âœ“ é…ç½®è‡ªåŠ¨ç”Ÿæˆ"
    echo "  âœ“ ç½‘ç»œè´¨é‡è¯Šæ–­"
    echo "  âœ“ å†å²æ•°æ®åˆ†æ"
    echo ""
}

# æ£€æŸ¥ç³»ç»Ÿ
check_system() {
    step "æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ..."
    
    if [ ! -f /etc/openwrt_release ]; then
        warn "âš ï¸  è¿™ä¸ªè„šæœ¬ä¸“ä¸º OpenWrt ç³»ç»Ÿè®¾è®¡"
        echo -n "æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ(y/N): "
        read -r choice
        if [ "$choice" != "y" ] && [ "$choice" != "Y" ]; then
            log "å®‰è£…å·²å–æ¶ˆ"
            exit 0
        fi
    fi
    
    if [ -f /etc/openwrt_release ]; then
        . /etc/openwrt_release
        log "âœ… æ£€æµ‹åˆ° OpenWrt: $DISTRIB_DESCRIPTION"
    fi
}

# æ£€æŸ¥ root æƒé™
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        error "âŒ è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬"
    fi
    log "âœ… æƒé™æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥ç½‘ç»œè¿æ¥
check_network() {
    step "æ£€æŸ¥ç½‘ç»œè¿æ¥..."
    
    if ping -c 1 -W 3 8.8.8.8 >/dev/null 2>&1; then
        log "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸"
    else
        warn "âš ï¸  ç½‘ç»œè¿æ¥å¯èƒ½æœ‰é—®é¢˜ï¼Œç»§ç»­å®‰è£…..."
    fi
}

# å®‰è£…ä¾èµ–
install_dependencies() {
    step "å®‰è£…ç³»ç»Ÿä¾èµ–..."
    
    log "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
    opkg update >/dev/null 2>&1 || warn "åŒ…åˆ—è¡¨æ›´æ–°å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
    
    local packages="tcpdump curl coreutils-timeout"
    for pkg in $packages; do
        if opkg list-installed | grep -q "^$pkg "; then
            log "âœ… $pkg å·²å®‰è£…"
        else
            log "å®‰è£… $pkg..."
            if opkg install "$pkg" >/dev/null 2>&1; then
                log "âœ… $pkg å®‰è£…æˆåŠŸ"
            else
                warn "âš ï¸  å®‰è£… $pkg å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å®‰è£…: opkg install $pkg"
            fi
        fi
    done
}

# åˆ›å»ºç›®å½•ç»“æ„
create_directories() {
    step "åˆ›å»ºç›®å½•ç»“æ„..."
    
    for dir in "$WEB_DIR" "$CGI_DIR" "$CONFIG_DIR" "$LOG_DIR" "/tmp/iptv_discovery"; do
        if mkdir -p "$dir" 2>/dev/null; then
            log "âœ… åˆ›å»ºç›®å½•: $dir"
        else
            error "âŒ åˆ›å»ºç›®å½•å¤±è´¥: $dir"
        fi
    done
}

# å®‰è£…æ ¸å¿ƒåŠŸèƒ½è„šæœ¬
install_core_scripts() {
    step "å®‰è£…æ ¸å¿ƒåŠŸèƒ½è„šæœ¬..."
    
    # ä¸»ç›‘æ§è„šæœ¬
    cat > "$SCRIPT_DIR/iptv-monitor" << 'EOF'
#!/bin/sh

# IPTV æµé‡ç›‘æ§è„šæœ¬

CONFIG_FILE="/etc/iptv_discovery/config"
if [ -f "$CONFIG_FILE" ]; then
    . "$CONFIG_FILE"
fi

MONITOR_INTERFACE=${MONITOR_INTERFACE:-eth1}
MONITOR_DURATION=${MONITOR_DURATION:-180}
OUTPUT_DIR="/tmp/iptv_discovery"

mkdir -p "$OUTPUT_DIR"

echo "ğŸ¬ å¼€å§‹IPTVæµé‡ç›‘æ§"
echo "ğŸ“¡ æ¥å£: $MONITOR_INTERFACE"
echo "â±ï¸  æ—¶é•¿: $MONITOR_DURATION ç§’"

# æ£€æŸ¥æ¥å£
if ! ip link show "$MONITOR_INTERFACE" >/dev/null 2>&1; then
    echo "âŒ é”™è¯¯: æ¥å£ $MONITOR_INTERFACE ä¸å­˜åœ¨"
    echo "å¯ç”¨æ¥å£:"
    ip link show | grep "^[0-9]:" | awk -F: '{print $2}' | tr -d ' '
    exit 1
fi

# æ£€æŸ¥æ¥å£çŠ¶æ€
INTERFACE_STATE=$(ip link show "$MONITOR_INTERFACE" | grep -o "state [A-Z]*" | cut -d' ' -f2)
if [ "$INTERFACE_STATE" != "UP" ]; then
    echo "âš ï¸  è­¦å‘Š: æ¥å£ $MONITOR_INTERFACE çŠ¶æ€ä¸º $INTERFACE_STATE"
    echo "å°è¯•å¯ç”¨æ¥å£..."
    ip link set "$MONITOR_INTERFACE" up 2>/dev/null && echo "âœ… æ¥å£å·²å¯ç”¨" || echo "âŒ æ¥å£å¯ç”¨å¤±è´¥"
fi

# æ•è·æµé‡
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
PCAP_FILE="$OUTPUT_DIR/iptv_capture_$TIMESTAMP.pcap"
LOG_FILE="$LOG_DIR/monitor_$TIMESTAMP.log"

{
    echo "========================================"
    echo "IPTVæµé‡ç›‘æ§æŠ¥å‘Š"
    echo "å¼€å§‹æ—¶é—´: $(date)"
    echo "æ¥å£: $MONITOR_INTERFACE"
    echo "æ—¶é•¿: $MONITOR_DURATION ç§’"
    echo "========================================"
    
    echo "ğŸ“¡ å¼€å§‹æ•è·æµé‡..."
    timeout "$MONITOR_DURATION" tcpdump -i "$MONITOR_INTERFACE" -w "$PCAP_FILE" -c 500 udp and portrange 10000-65000 2>&1
    
    if [ ! -f "$PCAP_FILE" ] || [ ! -s "$PCAP_FILE" ]; then
        echo "âŒ é”™è¯¯: æœªæ•è·åˆ°æµé‡æ•°æ®"
        echo "å¯èƒ½çš„åŸå› :"
        echo "  - æ¥å£ $MONITOR_INTERFACE æ²¡æœ‰æµé‡"
        echo "  - ç›‘æ§æ—¶é•¿å¤ªçŸ­"
        echo "  - ç½‘ç»œè¿æ¥é—®é¢˜"
        exit 1
    fi
    
    echo "ğŸ” åˆ†ææ•è·çš„æµé‡..."
    echo "æ–‡ä»¶å¤§å°: $(du -h "$PCAP_FILE" | cut -f1)"
    
    # æå–ç»„æ’­æµ
    MULTICAST_STREAMS=$(tcpdump -nn -r "$PCAP_FILE" udp 2>/dev/null | \
        grep -oE '> ([0-9]{1,3}\.){3}[0-9]{1,3}\.[0-9]{1,5}' | \
        sed 's/> //' | \
        grep -E '^22[0-9]|^23[0-9]|^239' | \
        sort | uniq -c | sort -nr)
    
    OUTPUT_FILE="/tmp/iptv_streams_$TIMESTAMP.txt"
    
    {
        echo "========================================"
        echo "IPTVç»„æ’­æµå‘ç°æŠ¥å‘Š"
        echo "ç”Ÿæˆæ—¶é—´: $(date)"
        echo "ç›‘æ§æ¥å£: $MONITOR_INTERFACE"
        echo "ç›‘æ§æ—¶é•¿: $MONITOR_DURATION ç§’"
        echo "æ•è·æ–‡ä»¶: $PCAP_FILE"
        echo "========================================"
        echo ""
        echo "ğŸ“Š å‘ç°çš„ç»„æ’­æµ:"
        echo "----------------"
        if [ -n "$MULTICAST_STREAMS" ]; then
            echo "è®¡æ•° | IPåœ°å€:ç«¯å£"
            echo "----------------"
            echo "$MULTICAST_STREAMS"
        else
            echo "âŒ æœªå‘ç°ç»„æ’­æµ"
        fi
    } > "$OUTPUT_FILE"
    
    # æ˜¾ç¤ºç»“æœ
    STREAM_COUNT=$(echo "$MULTICAST_STREAMS" | grep -c . 2>/dev/null || echo 0)
    echo ""
    echo "========================================"
    if [ "$STREAM_COUNT" -gt 0 ]; then
        echo "âœ… ç›‘æ§å®Œæˆ!"
        echo "ğŸ“º å‘ç° $STREAM_COUNT ä¸ªç»„æ’­æµ"
        echo "ğŸ“„ æŠ¥å‘Šæ–‡ä»¶: $OUTPUT_FILE"
        echo "ğŸ’¾ æŠ“åŒ…æ–‡ä»¶: $PCAP_FILE"
        
        # æ˜¾ç¤ºå‰5ä¸ªæµ
        echo ""
        echo "ğŸ† æœ€æ´»è·ƒçš„æµ:"
        echo "$MULTICAST_STREAMS" | head -5
    else
        echo "âš ï¸  ç›‘æ§å®Œæˆï¼Œä½†æœªå‘ç°ç»„æ’­æµ"
        echo "ğŸ’¡ å»ºè®®:"
        echo "  - æ£€æŸ¥ç½‘ç»œè¿æ¥"
        echo "  - ç¡®è®¤IPTVä¿¡å·æ­£å¸¸"
        echo "  - å¢åŠ ç›‘æ§æ—¶é•¿"
        echo "  - å°è¯•å…¶ä»–ç½‘ç»œæ¥å£"
    fi
    echo "========================================"
    
} | tee "$LOG_FILE"

echo "ğŸ“ è¯¦ç»†æ—¥å¿—: $LOG_FILE"
EOF

    # æµé‡åˆ†æè„šæœ¬
    cat > "$SCRIPT_DIR/iptv-analyze" << 'EOF'
#!/bin/sh

# IPTV æµé‡åˆ†æè„šæœ¬

PCAP_FILE="$1"

if [ -z "$PCAP_FILE" ] || [ ! -f "$PCAP_FILE" ]; then
    echo "âŒ ç”¨æ³•: $0 <pcapæ–‡ä»¶>"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0 /tmp/iptv_discovery/iptv_capture_20231201_120000.pcap"
    echo ""
    echo "å¯ç”¨çš„æŠ“åŒ…æ–‡ä»¶:"
    ls -la /tmp/iptv_discovery/iptv_capture_*.pcap 2>/dev/null | head -5
    exit 1
fi

echo "ğŸ” åˆ†æ IPTV æµé‡: $PCAP_FILE"
echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(du -h "$PCAP_FILE" | cut -f1)"
echo "========================================"

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
if [ ! -s "$PCAP_FILE" ]; then
    echo "âŒ é”™è¯¯: æ•è·æ–‡ä»¶ä¸ºç©º"
    exit 1
fi

# æå– UDP æµä¿¡æ¯
echo "ğŸ“¡ åˆ†æç»„æ’­æµé‡..."
MULTICAST_STREAMS=$(tcpdump -nn -r "$PCAP_FILE" udp 2>/dev/null | \
    grep -oE '> ([0-9]{1,3}\.){3}[0-9]{1,3}\.[0-9]{1,5}' | \
    sed 's/> //' | \
    grep -E '^22[0-9]|^23[0-9]|^239' | \
    sort | uniq -c | sort -nr)

OUTPUT_FILE="/tmp/iptv_analysis_$(date +%Y%m%d_%H%M%S).txt"

if [ -n "$MULTICAST_STREAMS" ]; then
    {
        echo "IPTV æµé‡åˆ†ææŠ¥å‘Š"
        echo "ç”Ÿæˆæ—¶é—´: $(date)"
        echo "åˆ†ææ–‡ä»¶: $PCAP_FILE"
        echo "========================================"
        echo ""
        echo "ğŸ“º å‘ç°çš„ç»„æ’­æµ:"
        echo "========================"
        echo "è®¡æ•° | IPåœ°å€:ç«¯å£"
        echo "----------------"
        echo "$MULTICAST_STREAMS"
        echo ""
        echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
        echo "========================"
        TOTAL_STREAMS=$(echo "$MULTICAST_STREAMS" | wc -l)
        echo "æ€»æµæ•°é‡: $TOTAL_STREAMS"
        
        # æ˜¾ç¤ºå‰10ä¸ªæœ€æ´»è·ƒçš„æµ
        echo ""
        echo "ğŸ† æœ€æ´»è·ƒçš„å‰10ä¸ªæµ:"
        echo "$MULTICAST_STREAMS" | head -10
    } > "$OUTPUT_FILE"
    
    echo ""
    echo "âœ… åˆ†æå®Œæˆ!"
    echo "ğŸ“„ æŠ¥å‘Šæ–‡ä»¶: $OUTPUT_FILE"
    echo ""
    echo "ğŸ“º å‘ç°çš„ç»„æ’­æµ:"
    echo "========================"
    echo "$MULTICAST_STREAMS" | head -15
    echo ""
    echo "ğŸ“Š å…±å‘ç° $TOTAL_STREAMS ä¸ªç»„æ’­æµ"
    
else
    echo ""
    echo "âŒ æœªå‘ç°æ˜æ˜¾çš„ IPTV ç»„æ’­æµé‡"
    echo ""
    echo "ğŸ’¡ å¯èƒ½çš„åŸå› :"
    echo "  1. é€‰æ‹©çš„æ¥å£ä¸æ­£ç¡®"
    echo "  2. ç›‘æ§æœŸé—´æ²¡æœ‰ IPTV æµé‡"
    echo "  3. è¿‡æ»¤è§„åˆ™è¿‡äºä¸¥æ ¼"
    echo "  4. ç½‘ç»œè¿æ¥é—®é¢˜"
fi

# æ˜¾ç¤ºåŸºç¡€ç»Ÿè®¡
echo ""
echo "ğŸ“ˆ æµé‡ç»Ÿè®¡æ‘˜è¦:"
tcpdump -nn -r "$PCAP_FILE" 2>/dev/null | awk '
    {
        proto = $1
        if (proto == "IP") {
            src = $3
            dst = $5
            gsub(/[.:][0-9]*$/, "", src)
            gsub(/[.:][0-9]*$/, "", dst)
            if (src != "" && dst != "") {
                count[src" -> "dst]++
                protocols[proto]++
            }
        }
    }
    END {
        print "ğŸŒ æµé‡åˆ†å¸ƒ:"
        for (flow in count) {
            if (count[flow] > 1) {
                print "  " count[flow] " åŒ…: " flow
            }
        }
    }' | head -8
EOF

    # å¿«é€Ÿæµ‹è¯•è„šæœ¬
    cat > "$SCRIPT_DIR/iptv-quicktest" << 'EOF'
#!/bin/sh

# IPTV å¿«é€Ÿæµ‹è¯•è„šæœ¬

echo "ğŸ§ª IPTV å¿«é€Ÿæµ‹è¯•å¼€å§‹..."
echo "â±ï¸  æ—¶é—´: $(date)"
echo "========================================"

# é…ç½®è¯»å–å‡½æ•°
get_config() {
    local key="$1"
    local default="$2"
    local value
    
    if [ -f "/etc/iptv_discovery/config" ]; then
        value=$(grep "^$key=" "/etc/iptv_discovery/config" | cut -d'=' -f2-)
        if [ -n "$value" ]; then
            echo "$value"
            return 0
        fi
    fi
    
    echo "$default"
}

INTERFACE=$(get_config "MONITOR_INTERFACE" "eth1")

echo ""
echo "1. ğŸ”§ ç³»ç»Ÿç»„ä»¶æ£€æŸ¥:"
echo "------------------"
for component in iptv-monitor iptv-analyze tcpdump; do
    if command -v "$component" >/dev/null 2>&1; then
        echo "   âœ… $component"
    else
        echo "   âŒ $component"
    fi
done

echo ""
echo "2. ğŸŒ ç½‘ç»œæ¥å£æ£€æŸ¥:"
echo "------------------"
echo "   ç›‘æ§æ¥å£: $INTERFACE"

if ip link show "$INTERFACE" >/dev/null 2>&1; then
    STATE=$(ip link show "$INTERFACE" | grep -o "state [A-Z]*" | cut -d' ' -f2)
    echo "   æ¥å£çŠ¶æ€: $STATE"
    
    IP_ADDR=$(ip addr show "$INTERFACE" | grep "inet " | awk '{print $2}' | head -1)
    if [ -n "$IP_ADDR" ]; then
        echo "   IPåœ°å€: $IP_ADDR"
    else
        echo "   IPåœ°å€: âŒ æ— "
    fi
else
    echo "   æ¥å£çŠ¶æ€: âŒ ä¸å­˜åœ¨"
fi

echo ""
echo "3. ğŸ“¡ æµé‡æ•è·æµ‹è¯•:"
echo "------------------"
echo "   å¼€å§‹10ç§’å¿«é€Ÿæµé‡æµ‹è¯•..."
timeout 10 tcpdump -i "$INTERFACE" -c 5 udp 2>/dev/null && \
    echo "   âœ… æµé‡æ•è·: æ­£å¸¸" || \
    echo "   âŒ æµé‡æ•è·: æ— æµé‡"

echo ""
echo "4. ğŸ“ ç›®å½•å’Œæƒé™æ£€æŸ¥:"
echo "------------------"
for dir in /www/iptv /www/cgi-bin /etc/iptv_discovery /var/log/iptv_discovery; do
    if [ -d "$dir" ]; then
        echo "   âœ… $dir"
    else
        echo "   âŒ $dir"
    fi
done

echo ""
echo "5. ğŸ”— WebæœåŠ¡æ£€æŸ¥:"
echo "------------------"
if pgrep uhttpd >/dev/null; then
    echo "   âœ… uHTTPdæœåŠ¡: è¿è¡Œä¸­"
else
    echo "   âŒ uHTTPdæœåŠ¡: æœªè¿è¡Œ"
fi

echo ""
echo "========================================"
echo "âœ… å¿«é€Ÿæµ‹è¯•å®Œæˆ: $(date)"
echo ""
echo "ğŸ’¡ ä¸‹ä¸€æ­¥:"
echo "  è¿è¡Œ 'iptv-monitor' å¼€å§‹ç›‘æ§"
echo "  è®¿é—® http://ä½ çš„è·¯ç”±å™¨IP/iptv/ ä½¿ç”¨ç½‘é¡µç•Œé¢"
EOF

    # å®æ—¶ç›‘æ§è„šæœ¬
    cat > "$SCRIPT_DIR/iptv-realtime" << 'EOF'
#!/bin/sh

# IPTV å®æ—¶ç›‘æ§å®ˆæŠ¤è¿›ç¨‹

CONFIG_FILE="/etc/iptv_discovery/config"
if [ -f "$CONFIG_FILE" ]; then
    . "$CONFIG_FILE"
fi

MONITOR_INTERFACE=${MONITOR_INTERFACE:-eth1}
REALTIME_DURATION=${REALTIME_DURATION:-3600}

LOG_FILE="/var/log/iptv_discovery/realtime.log"
STATUS_FILE="/tmp/iptv_status.json"

# æ—¥å¿—å‡½æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# åˆ›å»ºçŠ¶æ€æ–‡ä»¶
create_status_file() {
    cat > "$STATUS_FILE" << STATUS_EOF
{
    "status": "running",
    "start_time": "$(date)",
    "interface": "$MONITOR_INTERFACE",
    "streams_found": 0,
    "last_update": "$(date)"
}
STATUS_EOF
}

# æ£€æŸ¥æ¥å£
check_interface() {
    if ! ip link show "$MONITOR_INTERFACE" >/dev/null 2>&1; then
        log "âŒ é”™è¯¯: ç½‘ç»œæ¥å£ $MONITOR_INTERFACE ä¸å­˜åœ¨"
        exit 1
    fi
}

log "ğŸš€ å¯åŠ¨ IPTV å®æ—¶ç›‘æ§å®ˆæŠ¤è¿›ç¨‹"
log "ğŸ“¡ ç›‘æ§æ¥å£: $MONITOR_INTERFACE"
log "â±ï¸  è¿è¡Œæ—¶é•¿: $REALTIME_DURATION ç§’"

# åˆ›å»ºçŠ¶æ€æ–‡ä»¶
create_status_file

# æ£€æŸ¥æ¥å£
check_interface

# ä¸»ç›‘æ§å¾ªç¯
END_TIME=$(( $(date +%s) + REALTIME_DURATION ))
while [ $(date +%s) -lt $END_TIME ]; do
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    TEMP_PCAP="/tmp/iptv_realtime_$TIMESTAMP.pcap"
    
    # æ•è·30ç§’æµé‡
    log "ğŸ“¡ æ•è·å®æ—¶æµé‡..."
    timeout 30 tcpdump -i "$MONITOR_INTERFACE" -w "$TEMP_PCAP" -c 200 udp 2>/dev/null || true
    
    if [ -f "$TEMP_PCAP" ] && [ -s "$TEMP_PCAP" ]; then
        # åˆ†ææµé‡
        STREAMS=$(tcpdump -nn -r "$TEMP_PCAP" udp 2>/dev/null | \
            grep -oE '> ([0-9]{1,3}\.){3}[0-9]{1,3}\.[0-9]{1,5}' | \
            sed 's/> //' | \
            grep -E '^22[0-9]|^23[0-9]|^239' | \
            sort | uniq | head -10)
        
        STREAM_COUNT=$(echo "$STREAMS" | grep -c . 2>/dev/null || echo 0)
        
        if [ "$STREAM_COUNT" -gt 0 ]; then
            log "âœ… å‘ç° $STREAM_COUNT ä¸ªæ´»è·ƒç»„æ’­æµ"
            
            # æ›´æ–°çŠ¶æ€æ–‡ä»¶
            cat > "$STATUS_FILE" << STATUS_EOF
{
    "status": "running",
    "start_time": "$(date)",
    "interface": "$MONITOR_INTERFACE",
    "streams_found": $STREAM_COUNT,
    "last_update": "$(date)",
    "sample_streams": "$(echo "$STREAMS" | head -3 | tr '\n' ' ')"
}
STATUS_EOF
        else
            log "âš ï¸  æœªå‘ç°æ´»è·ƒç»„æ’­æµ"
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f "$TEMP_PCAP"
    else
        log "âŒ æµé‡æ•è·å¤±è´¥"
    fi
    
    sleep 10
done

log "âœ… å®æ—¶ç›‘æ§å®Œæˆ"
cat > "$STATUS_FILE" << STATUS_EOF
{
    "status": "completed",
    "start_time": "$(date)",
    "end_time": "$(date)",
    "streams_found": 0
}
STATUS_EOF
EOF

    # é…ç½®ç”Ÿæˆè„šæœ¬
    cat > "$SCRIPT_DIR/iptv-generate-config" << 'EOF'
#!/bin/sh

# IPTV é…ç½®ç”Ÿæˆå™¨

CONFIG_TYPE="$1"
OUTPUT_FILE="$2"

if [ -z "$CONFIG_TYPE" ]; then
    echo "ğŸ›ï¸  IPTV é…ç½®ç”Ÿæˆå™¨"
    echo ""
    echo "ç”¨æ³•: $0 <é…ç½®ç±»å‹> [è¾“å‡ºæ–‡ä»¶]"
    echo ""
    echo "å¯ç”¨çš„é…ç½®ç±»å‹:"
    echo "  m3u       - M3U æ’­æ”¾åˆ—è¡¨"
    echo "  igmp      - IGMP ä»£ç†é…ç½®"
    echo "  udpxy     - udpxy é…ç½®"
    echo "  all       - ç”Ÿæˆæ‰€æœ‰é…ç½®"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0 m3u /tmp/iptv_playlist.m3u"
    echo "  $0 all"
    exit 1
fi

if [ -z "$OUTPUT_FILE" ]; then
    case "$CONFIG_TYPE" in
        m3u) OUTPUT_FILE="/tmp/iptv_playlist_$(date +%Y%m%d_%H%M%S).m3u" ;;
        igmp) OUTPUT_FILE="/tmp/igmp_config_$(date +%Y%m%d_%H%M%S).conf" ;;
        udpxy) OUTPUT_FILE="/tmp/udpxy_config_$(date +%Y%m%d_%H%M%S).conf" ;;
        *) OUTPUT_FILE="/tmp/iptv_${CONFIG_TYPE}_$(date +%Y%m%d_%H%M%S).conf" ;;
    esac
fi

# è·å–ç½‘ç»œé…ç½®
get_network_config() {
    local interface
    interface=$(grep "^MONITOR_INTERFACE" /etc/iptv_discovery/config 2>/dev/null | cut -d= -f2 || echo "eth1")
    local lan_ip=$(ip addr show br-lan 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1 | head -1)
    if [ -z "$lan_ip" ]; then
        lan_ip="192.168.1.1"
    fi
    
    echo "$interface,$lan_ip"
}

echo "âš™ï¸  ç”Ÿæˆ IPTV é…ç½®: $CONFIG_TYPE"
echo "ğŸ“„ è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE"

case "$CONFIG_TYPE" in
    m3u)
        echo "ğŸ“º ç”Ÿæˆ M3U æ’­æ”¾åˆ—è¡¨..."
        {
            echo "#EXTM3U"
            echo "# IPTV Playlist"
            echo "# Generated: $(date)"
            echo "# By IPTV Discovery System"
            echo ""
            
            # æŸ¥æ‰¾æœ€è¿‘çš„æµæ–‡ä»¶
            RECENT_FILE=$(ls -t /tmp/iptv_streams_*.txt 2>/dev/null | head -1)
            if [ -n "$RECENT_FILE" ] && [ -f "$RECENT_FILE" ]; then
                grep -E '^[0-9]+\s+[0-9]' "$RECENT_FILE" | head -20 | while read line; do
                    STREAM=$(echo "$line" | awk '{print $2}')
                    COUNT=$(echo "$line" | awk '{print $1}')
                    echo "#EXTINF:-1,Channel - $STREAM ($COUNT packets)"
                    echo "udp://$STREAM"
                    echo ""
                done
                echo "# Total channels: $(grep -cE '^[0-9]+\s+[0-9]' "$RECENT_FILE" 2>/dev/null || echo 0)"
            else
                # ç”Ÿæˆç¤ºä¾‹
                echo "#EXTINF:-1,Example HD Channel 1"
                echo "udp://239.1.1.1:10000"
                echo ""
                echo "#EXTINF:-1,Example HD Channel 2"
                echo "udp://239.1.1.2:10001"
                echo ""
                echo "#EXTINF:-1,Example SD Channel 1"
                echo "udp://239.1.2.1:20000"
            fi
        } > "$OUTPUT_FILE"
        echo "âœ… M3Uæ’­æ”¾åˆ—è¡¨å·²ç”Ÿæˆ: $OUTPUT_FILE"
        ;;
        
    igmp)
        echo "ğŸŒ ç”Ÿæˆ IGMP é…ç½®..."
        {
            echo "# IGMP Proxy Configuration"
            echo "# Generated: $(date)"
            echo ""
            echo "config igmpproxy"
            echo "    option quickleave 1"
            echo ""
            echo "config phyint"
            echo "    option network wan"
            echo "    option zone wan"
            echo "    option direction upstream"
            echo "    list altnet 0.0.0.0/0"
            echo ""
            echo "config phyint"
            echo "    option network lan"
            echo "    option zone lan"
            echo "    option direction downstream"
        } > "$OUTPUT_FILE"
        echo "âœ… IGMPé…ç½®å·²ç”Ÿæˆ: $OUTPUT_FILE"
        ;;
        
    udpxy)
        echo "ğŸ”„ ç”Ÿæˆ udpxy é…ç½®..."
        NETWORK_CONFIG=$(get_network_config)
        LAN_IP=$(echo "$NETWORK_CONFIG" | cut -d, -f2)
        
        {
            echo "# udpxy Configuration"
            echo "# Generated: $(date)"
            echo ""
            echo "config udpxy"
            echo "    option disabled 0"
            echo "    option respawn 1"
            echo "    option verbose 0"
            echo "    option status 1"
            echo "    option bind $LAN_IP"
            echo "    option port 4022"
            echo "    option source eth1"
            echo "    option mcsub_renew 60"
        } > "$OUTPUT_FILE"
        echo "âœ… udpxyé…ç½®å·²ç”Ÿæˆ: $OUTPUT_FILE"
        ;;
        
    all)
        echo "ğŸ¯ ç”Ÿæˆæ‰€æœ‰é…ç½®..."
        $0 m3u "/tmp/iptv_playlist_$(date +%Y%m%d_%H%M%S).m3u"
        $0 igmp "/tmp/igmp_config_$(date +%Y%m%d_%H%M%S).conf"
        $0 udpxy "/tmp/udpxy_config_$(date +%Y%m%d_%H%M%S).conf"
        echo ""
        echo "âœ… æ‰€æœ‰é…ç½®å·²ç”Ÿæˆåˆ° /tmp/ ç›®å½•"
        echo ""
        ls -la /tmp/iptv_* /tmp/igmp_* /tmp/udpxy_* 2>/dev/null
        ;;
        
    *)
        echo "âŒ é”™è¯¯: æœªçŸ¥çš„é…ç½®ç±»å‹: $CONFIG_TYPE"
        echo "ä½¿ç”¨ 'm3u', 'igmp', 'udpxy' æˆ– 'all'"
        exit 1
        ;;
esac

echo ""
echo "ğŸ‰ é…ç½®ç”Ÿæˆå®Œæˆ!"
EOF

    # è®¾ç½®æ‰§è¡Œæƒé™
    for script in iptv-monitor iptv-analyze iptv-quicktest iptv-realtime iptv-generate-config; do
        chmod +x "$SCRIPT_DIR/$script"
        log "âœ… è®¾ç½®æ‰§è¡Œæƒé™: $script"
    done
    
    log "âœ… æ ¸å¿ƒåŠŸèƒ½è„šæœ¬å®‰è£…å®Œæˆ"
}

# å®‰è£…ç½‘é¡µç•Œé¢
install_web_interface() {
    step "å®‰è£…ç½‘é¡µç•Œé¢..."
    
    # ä¸»é¡µé¢
    cat > "$WEB_DIR/index.html" << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV è‡ªåŠ¨å‘ç°ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        .nav {
            background: #3498db;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .nav-btn {
            background: none;
            border: none;
            color: white;
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            border-bottom: 3px solid transparent;
        }
        .nav-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        .nav-btn.active {
            background: rgba(255,255,255,0.2);
            border-bottom-color: #e74c3c;
        }
        .content {
            padding: 30px;
            min-height: 500px;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .btn-warning { background: #f39c12; }
        .btn-warning:hover { background: #e67e22; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .log-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.4;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-item {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .status-item:hover {
            transform: translateY(-5px);
        }
        .status-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            margin: 15px 0;
        }
        .progress {
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 15px 0;
        }
        .progress-bar {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            height: 100%;
            transition: width 0.3s;
        }
        .stream-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            .nav-btn {
                padding: 12px 15px;
                font-size: 14px;
            }
            .content {
                padding: 20px;
            }
            .status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ IPTV è‡ªåŠ¨å‘ç°ç³»ç»Ÿ</h1>
            <p>æ™ºèƒ½ç›‘æ§ã€åˆ†æå’Œé…ç½®æ‚¨çš„IPTVç½‘ç»œ</p>
        </div>
        
        <div class="nav">
            <button class="nav-btn active" data-tab="dashboard">ğŸ“Š ä»ªè¡¨æ¿</button>
            <button class="nav-btn" data-tab="monitor">ğŸ“¡ æµé‡ç›‘æ§</button>
            <button class="nav-btn" data-tab="channels">ğŸ“º é¢‘é“ç®¡ç†</button>
            <button class="nav-btn" data-tab="config">âš™ï¸ é…ç½®ç”Ÿæˆ</button>
            <button class="nav-btn" data-tab="tools">ğŸ”§ ç³»ç»Ÿå·¥å…·</button>
        </div>
        
        <div class="content">
            <!-- ä»ªè¡¨æ¿ -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h3>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <div>ç³»ç»ŸçŠ¶æ€</div>
                            <div class="status-value" id="system-status">å°±ç»ª</div>
                            <div>IPTVå‘ç°ç³»ç»Ÿ</div>
                        </div>
                        <div class="status-item">
                            <div>ç½‘ç»œæ¥å£</div>
                            <div class="status-value" id="interface-status">eth1</div>
                            <div>ç›‘æ§æ¥å£</div>
                        </div>
                        <div class="status-item">
                            <div>æœ€è¿‘å‘ç°</div>
                            <div class="status-value" id="channels-count">0</div>
                            <div>é¢‘é“æ•°é‡</div>
                        </div>
                        <div class="status-item">
                            <div>è¿è¡Œæ—¶é—´</div>
                            <div class="status-value" id="uptime-status">--</div>
                            <div>ç³»ç»ŸçŠ¶æ€</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
                    <button class="btn btn-success" onclick="runCommand('monitor')">
                        <span>â–¶ï¸</span>å¼€å§‹ç›‘æ§
                    </button>
                    <button class="btn" onclick="runCommand('quicktest')">
                        <span>ğŸ§ª</span>å¿«é€Ÿæµ‹è¯•
                    </button>
                    <button class="btn" onclick="runCommand('generate-m3u')">
                        <span>ğŸ“º</span>ç”Ÿæˆæ’­æ”¾åˆ—è¡¨
                    </button>
                    <button class="btn btn-warning" onclick="runCommand('stop')">
                        <span>â¹ï¸</span>åœæ­¢ç›‘æ§
                    </button>
                </div>
                
                <div class="card">
                    <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
                    <div class="log-output" id="output">
ğŸš€ IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿå·²å°±ç»ª
ğŸ’¡ é€‰æ‹©å·¦ä¾§åŠŸèƒ½å¼€å§‹ä½¿ç”¨...
â° ç³»ç»Ÿæ—¶é—´: <span id="current-time"></span>
                    </div>
                </div>
            </div>
            
            <!-- æµé‡ç›‘æ§ -->
            <div id="monitor" class="tab-content">
                <div class="card">
                    <h3>ğŸ“¡ æµé‡ç›‘æ§</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div>
                            <label><strong>ç›‘æ§æ¥å£:</strong></label>
                            <select id="monitor-interface" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 2px solid #ddd;">
                                <option value="eth1">eth1 (æ¨è)</option>
                                <option value="eth0">eth0</option>
                                <option value="br-lan">br-lan</option>
                                <option value="pppoe-wan">pppoe-wan</option>
                            </select>
                        </div>
                        <div>
                            <label><strong>ç›‘æ§æ—¶é•¿ (ç§’):</strong></label>
                            <input type="number" id="monitor-duration" value="180" style="width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 2px solid #ddd;">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="startAdvancedMonitor()">
                        <span>ğŸ“¡</span>å¼€å§‹ç›‘æ§
                    </button>
                    <button class="btn" onclick="runCommand('realtime')">
                        <span>ğŸ”´</span>å®æ—¶ç›‘æ§
                    </button>
                </div>
                
                <div class="card">
                    <h3>ğŸ“Š ç›‘æ§çŠ¶æ€</h3>
                    <div id="progress-container" style="display: none;">
                        <div style="display: flex; justify-content: between; align-items: center; margin: 10px 0;">
                            <span>ç›‘æ§è¿›åº¦:</span>
                            <span id="progress-text" style="font-weight: bold;">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="log-output" id="monitor-output">
ç­‰å¾…å¼€å§‹ç›‘æ§...
                    </div>
                </div>
            </div>
            
            <!-- é¢‘é“ç®¡ç† -->
            <div id="channels" class="tab-content">
                <div class="card">
                    <h3>ğŸ“º é¢‘é“ç®¡ç†</h3>
                    <button class="btn" onclick="runCommand('list-channels')">
                        <span>ğŸ”„</span>åˆ·æ–°é¢‘é“åˆ—è¡¨
                    </button>
                    <button class="btn btn-success" onclick="runCommand('analyze-channels')">
                        <span>ğŸ”</span>åˆ†æé¢‘é“
                    </button>
                </div>
                
                <div class="card">
                    <h3>ğŸ” é¢‘é“åˆ—è¡¨</h3>
                    <div class="log-output" id="channels-output">
ç‚¹å‡»"åˆ·æ–°é¢‘é“åˆ—è¡¨"åŠ è½½æ•°æ®...
                    </div>
                </div>
            </div>
            
            <!-- é…ç½®ç”Ÿæˆ -->
            <div id="config" class="tab-content">
                <div class="card">
                    <h3>âš™ï¸ é…ç½®ç”Ÿæˆå™¨</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button class="btn" onclick="runCommand('generate-m3u')">
                            <span>ğŸ“º</span>M3Uæ’­æ”¾åˆ—è¡¨
                        </button>
                        <button class="btn" onclick="runCommand('generate-igmp')">
                            <span>ğŸŒ</span>IGMPé…ç½®
                        </button>
                        <button class="btn" onclick="runCommand('generate-udpxy')">
                            <span>ğŸ”„</span>udpxyé…ç½®
                        </button>
                        <button class="btn btn-success" onclick="runCommand('generate-all')">
                            <span>ğŸ¯</span>ç”Ÿæˆæ‰€æœ‰é…ç½®
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“„ é…ç½®è¾“å‡º</h3>
                    <div class="log-output" id="config-output">
é€‰æ‹©ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆé…ç½®...
                    </div>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿå·¥å…· -->
            <div id="tools" class="tab-content">
                <div class="card">
                    <h3>ğŸ”§ ç³»ç»Ÿå·¥å…·</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                        <button class="btn" onclick="runCommand('network-test')">
                            <span>ğŸŒ</span>ç½‘ç»œæµ‹è¯•
                        </button>
                        <button class="btn" onclick="runCommand('analyze-history')">
                            <span>ğŸ“Š</span>å†å²åˆ†æ
                        </button>
                        <button class="btn" onclick="runCommand('cleanup')">
                            <span>ğŸ§¹</span>æ¸…ç†æ–‡ä»¶
                        </button>
                        <button class="btn btn-warning" onclick="runCommand('restart-services')">
                            <span>ğŸ”„</span>é‡å¯æœåŠ¡
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“‹ å·¥å…·è¾“å‡º</h3>
                    <div class="log-output" id="tools-output">
é€‰æ‹©å·¥å…·å¼€å§‹ä½¿ç”¨...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é€‰é¡¹å¡åˆ‡æ¢
        document.querySelectorAll('.nav-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        // æ›´æ–°å½“å‰æ—¶é—´
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
        }
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();

        // æ·»åŠ æ—¥å¿—
        function addLog(message, target = 'output') {
            const element = document.getElementById(target);
            const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const logEntry = `[${timestamp}] ${message}`;
            element.innerHTML = logEntry + '<br>' + element.innerHTML;
        }

        // è¿è¡Œå‘½ä»¤
        function runCommand(command) {
            addLog(`æ‰§è¡Œå‘½ä»¤: ${command}`);
            
            const xhr = new XMLHttpRequest();
            const url = `/cgi-bin/iptv-web?action=${command}`;
            xhr.open('GET', url, true);
            xhr.timeout = 60000; // 60ç§’è¶…æ—¶
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    let outputTarget = 'output';
                    switch(command) {
                        case 'list-channels':
                        case 'analyze-channels':
                            outputTarget = 'channels-output';
                            break;
                        case 'generate-m3u':
                        case 'generate-igmp':
                        case 'generate-udpxy':
                        case 'generate-all':
                            outputTarget = 'config-output';
                            break;
                        case 'network-test':
                        case 'analyze-history':
                        case 'cleanup':
                        case 'restart-services':
                            outputTarget = 'tools-output';
                            break;
                        default:
                            outputTarget = 'output';
                    }
                    
                    // æ¸…ç†è¾“å‡ºåŒºåŸŸ
                    document.getElementById(outputTarget).innerHTML = '';
                    addLog(xhr.responseText, outputTarget);
                } else {
                    addLog(`âŒ é”™è¯¯: æœåŠ¡å™¨è¿”å›çŠ¶æ€ ${xhr.status}`);
                }
            };
            
            xhr.onerror = function() {
                addLog('âŒ é”™è¯¯: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                addLog('ğŸ’¡ è¯·æ£€æŸ¥:');
                addLog('  1. uHTTPdæœåŠ¡æ˜¯å¦è¿è¡Œ: /etc/init.d/uhttpd status');
                addLog('  2. é˜²ç«å¢™æ˜¯å¦å…è®¸80ç«¯å£è®¿é—®');
                addLog('  3. CGIè„šæœ¬æƒé™: chmod +x /www/cgi-bin/iptv-web');
            };
            
            xhr.ontimeout = function() {
                addLog('â±ï¸  è­¦å‘Š: è¯·æ±‚è¶…æ—¶ï¼Œå‘½ä»¤å¯èƒ½ä»åœ¨æ‰§è¡Œä¸­');
            };
            
            xhr.send();
        }

        // é«˜çº§ç›‘æ§
        function startAdvancedMonitor() {
            const interface = document.getElementById('monitor-interface').value;
            const duration = parseInt(document.getElementById('monitor-duration').value);
            
            addLog(`ğŸš€ å¼€å§‹é«˜çº§ç›‘æ§ - æ¥å£: ${interface}, æ—¶é•¿: ${duration}ç§’`);
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            
            // æ¨¡æ‹Ÿè¿›åº¦
            let progress = 0;
            const interval = setInterval(() => {
                progress += 100 / duration;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 2000);
                }
                progressBar.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
            }, 1000);
            
            runCommand(`advanced-monitor&interface=${interface}&duration=${duration}`);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ‰ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            addLog('ğŸ’¡ æç¤º: ä½¿ç”¨å‰è¯·å…ˆè¿è¡Œ"å¿«é€Ÿæµ‹è¯•"æ£€æŸ¥ç³»ç»ŸçŠ¶æ€');
            addLog('ğŸŒ è®¿é—®: http://ä½ çš„è·¯ç”±å™¨IP/iptv/');
            
            // æ›´æ–°ç³»ç»ŸçŠ¶æ€
            updateSystemStatus();
            setInterval(updateSystemStatus, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
        });

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus() {
            // æ¨¡æ‹ŸçŠ¶æ€æ›´æ–°
            const interfaces = ['eth1', 'eth0', 'br-lan'];
            const randomInterface = interfaces[Math.floor(Math.random() * interfaces.length)];
            const randomChannels = Math.floor(Math.random() * 50);
            
            document.getElementById('interface-status').textContent = randomInterface;
            document.getElementById('channels-count').textContent = randomChannels;
            document.getElementById('uptime-status').textContent = Math.floor(Math.random() * 24) + 'å°æ—¶';
        }
    </script>
</body>
</html>
EOF

    log "âœ… ç½‘é¡µç•Œé¢éƒ¨ç½²å®Œæˆ"
}

# å®‰è£…CGIè„šæœ¬
install_cgi_scripts() {
    step "å®‰è£…CGIè„šæœ¬..."
    
    # ä¸»CGIå¤„ç†è„šæœ¬
    cat > "$CGI_DIR/iptv-web" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# è®°å½•æ—¥å¿—
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> /var/log/iptv_discovery/web_interface.log
}

# è·å–åŠ¨ä½œå‚æ•°
ACTION=$(echo "$QUERY_STRING" | sed -n 's/.*action=\([^&]*\).*/\1/p')

# å¦‚æœæ²¡æœ‰æŒ‡å®šåŠ¨ä½œï¼Œæ˜¾ç¤ºå¸®åŠ©
if [ -z "$ACTION" ]; then
    echo "ğŸ›ï¸  IPTV Web Interface - å¯ç”¨å‘½ä»¤:"
    echo "========================================"
    echo "monitor           - å¼€å§‹åŸºç¡€ç›‘æ§ (3åˆ†é’Ÿ)"
    echo "quicktest         - å¿«é€Ÿç³»ç»Ÿæµ‹è¯•"
    echo "stop              - åœæ­¢æ‰€æœ‰ç›‘æ§"
    echo "realtime          - å¯åŠ¨å®æ—¶ç›‘æ§ (1å°æ—¶)"
    echo "list-channels     - åˆ—å‡ºå‘ç°çš„é¢‘é“"
    echo "analyze-channels  - åˆ†æé¢‘é“"
    echo "generate-m3u      - ç”ŸæˆM3Uæ’­æ”¾åˆ—è¡¨"
    echo "generate-igmp     - ç”ŸæˆIGMPé…ç½®"
    echo "generate-udpxy    - ç”Ÿæˆudpxyé…ç½®"
    echo "generate-all      - ç”Ÿæˆæ‰€æœ‰é…ç½®"
    echo "network-test      - ç½‘ç»œæµ‹è¯•"
    echo "analyze-history   - å†å²æ•°æ®åˆ†æ"
    echo "cleanup           - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
    echo "restart-services  - é‡å¯æœåŠ¡"
    echo ""
    echo "é«˜çº§ç›‘æ§: advanced-monitor&interface=eth1&duration=180"
    echo "========================================"
    exit 0
fi

log "Webè¯·æ±‚: $ACTION"

# æ ¹æ®åŠ¨ä½œæ‰§è¡Œç›¸åº”å‘½ä»¤
case "$ACTION" in
    monitor)
        echo "ğŸ¬ å¼€å§‹åŸºç¡€IPTVæµé‡ç›‘æ§..."
        echo "â±ï¸  é¢„è®¡æ—¶é•¿: 3åˆ†é’Ÿ"
        echo "========================================"
        /usr/bin/iptv-monitor
        ;;
        
    quicktest)
        echo "ğŸ§ª æ‰§è¡Œç³»ç»Ÿå¿«é€Ÿæµ‹è¯•..."
        echo "========================================"
        /usr/bin/iptv-quicktest
        ;;
        
    stop)
        echo "â¹ï¸  åœæ­¢æ‰€æœ‰ç›‘æ§è¿›ç¨‹..."
        echo "========================================"
        pkill -f "iptv-monitor" && echo "âœ… åŸºç¡€ç›‘æ§å·²åœæ­¢" || echo "â„¹ï¸  åŸºç¡€ç›‘æ§æœªè¿è¡Œ"
        pkill -f "iptv-realtime" && echo "âœ… å®æ—¶ç›‘æ§å·²åœæ­¢" || echo "â„¹ï¸  å®æ—¶ç›‘æ§æœªè¿è¡Œ"
        pkill -f "tcpdump.*iptv" && echo "âœ… æŠ“åŒ…è¿›ç¨‹å·²åœæ­¢" || echo "â„¹ï¸  æ— æŠ“åŒ…è¿›ç¨‹è¿è¡Œ"
        echo "âœ… æ‰€æœ‰ç›‘æ§è¿›ç¨‹å·²åœæ­¢"
        ;;
        
    realtime)
        echo "ğŸ”´ å¯åŠ¨å®æ—¶ç›‘æ§å®ˆæŠ¤è¿›ç¨‹..."
        echo "â±ï¸  è¿è¡Œæ—¶é•¿: 1å°æ—¶"
        echo "========================================"
        if pgrep -f "iptv-realtime" >/dev/null; then
            echo "âœ… å®æ—¶ç›‘æ§å·²åœ¨è¿è¡Œ (PID: $(pgrep -f "iptv-realtime"))"
        else
            /usr/bin/iptv-realtime &
            echo "âœ… å®æ—¶ç›‘æ§å·²å¯åŠ¨ (PID: $!)"
            echo "ğŸ“Š çŠ¶æ€æ–‡ä»¶: /tmp/iptv_status.json"
        fi
        ;;
        
    list-channels)
        echo "ğŸ“º å‘ç°çš„IPTVé¢‘é“åˆ—è¡¨"
        echo "========================================"
        RECENT_FILE=$(ls -t /tmp/iptv_streams_*.txt 2>/dev/null | head -1)
        if [ -n "$RECENT_FILE" ] && [ -f "$RECENT_FILE" ]; then
            echo "ğŸ“„ æ•°æ®æ–‡ä»¶: $(basename "$RECENT_FILE")"
            echo ""
            grep -E '^[0-9]+\s+[0-9]' "$RECENT_FILE" | head -20 | while read line; do
                COUNT=$(echo "$line" | awk '{print $1}')
                STREAM=$(echo "$line" | awk '{print $2}')
                echo "ğŸ“¡ $STREAM (å‡ºç°: $COUNT æ¬¡)"
            done
            TOTAL=$(grep -cE '^[0-9]+\s+[0-9]' "$RECENT_FILE" 2>/dev/null || echo 0)
            echo ""
            echo "ğŸ“Š æ€»è®¡: $TOTAL ä¸ªé¢‘é“"
        else
            echo "âŒ æœªå‘ç°é¢‘é“æ•°æ®"
            echo "ğŸ’¡ è¯·å…ˆè¿è¡Œç›‘æ§åŠŸèƒ½"
        fi
        ;;
        
    analyze-channels)
        echo "ğŸ” é¢‘é“åˆ†ææŠ¥å‘Š"
        echo "========================================"
        RECENT_FILE=$(ls -t /tmp/iptv_streams_*.txt 2>/dev/null | head -1)
        if [ -n "$RECENT_FILE" ] && [ -f "$RECENT_FILE" ]; then
            echo "æ­£åœ¨åˆ†æé¢‘é“æ•°æ®..."
            echo ""
            # ç®€å•çš„åˆ†æ
            TOTAL=$(grep -cE '^[0-9]+\s+[0-9]' "$RECENT_FILE" 2>/dev/null || echo 0)
            echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
            echo "  - æ€»é¢‘é“æ•°: $TOTAL"
            echo ""
            echo "ğŸŒ IPæ®µåˆ†å¸ƒ:"
            grep -E '^[0-9]+\s+[0-9]' "$RECENT_FILE" 2>/dev/null | awk '{print $2}' | cut -d. -f1-3 | sort | uniq -c | sort -nr | head -5 | while read line; do
                echo "  - $line"
            done
            echo ""
            echo "ğŸ”¢ ç«¯å£èŒƒå›´:"
            grep -E '^[0-9]+\s+[0-9]' "$RECENT_FILE" 2>/dev/null | awk '{print $2}' | cut -d: -f2 | sort -n | awk '
                NR==1{min=$1} 
                END{max=$1} 
                END{print "  - ç«¯å£èŒƒå›´: " min " - " max}'
        else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°é¢‘é“æ•°æ®æ–‡ä»¶"
        fi
        ;;
        
    generate-m3u)
        echo "ğŸ“º ç”ŸæˆM3Uæ’­æ”¾åˆ—è¡¨..."
        echo "========================================"
        /usr/bin/iptv-generate-config m3u
        ;;
        
    generate-igmp)
        echo "ğŸŒ ç”ŸæˆIGMPä»£ç†é…ç½®..."
        echo "========================================"
        /usr/bin/iptv-generate-config igmp
        ;;
        
    generate-udpxy)
        echo "ğŸ”„ ç”Ÿæˆudpxyé…ç½®..."
        echo "========================================"
        /usr/bin/iptv-generate-config udpxy
        ;;
        
    generate-all)
        echo "ğŸ¯ ç”Ÿæˆæ‰€æœ‰IPTVé…ç½®..."
        echo "========================================"
        /usr/bin/iptv-generate-config all
        ;;
        
    network-test)
        echo "ğŸŒ ç½‘ç»œæ¥å£æµ‹è¯•..."
        echo "========================================"
        echo "æµ‹è¯•æ¥å£: eth1"
        echo "æµ‹è¯•æ—¶é•¿: 30ç§’"
        echo ""
        # ç®€å•çš„ç½‘ç»œæµ‹è¯•
        if ip link show eth1 >/dev/null 2>&1; then
            echo "âœ… æ¥å£ eth1 å­˜åœ¨"
            STATE=$(ip link show eth1 | grep -o "state [A-Z]*" | cut -d' ' -f2)
            echo "ğŸ“¡ æ¥å£çŠ¶æ€: $STATE"
        else
            echo "âŒ æ¥å£ eth1 ä¸å­˜åœ¨"
        fi
        ;;
        
    analyze-history)
        echo "ğŸ“Š å†å²æ•°æ®åˆ†æ"
        echo "========================================"
        echo "åˆ†ææœ€è¿‘7å¤©çš„æ•°æ®..."
        echo ""
        HISTORY_FILES=$(find /tmp -name "iptv_streams_*.txt" -mtime -7 2>/dev/null | wc -l)
        CAPTURE_FILES=$(find /tmp/iptv_discovery -name "*.pcap" -mtime -7 2>/dev/null | wc -l)
        echo "ğŸ“ æ‰¾åˆ° $HISTORY_FILES ä¸ªæµæ–‡ä»¶"
        echo "ğŸ“ æ‰¾åˆ° $CAPTURE_FILES ä¸ªæŠ“åŒ…æ–‡ä»¶"
        echo ""
        echo "ğŸ’¡ æç¤º: å®Œæ•´åŠŸèƒ½è¯·ä½¿ç”¨ iptv-analyze-history å‘½ä»¤"
        ;;
        
    cleanup)
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        echo "========================================"
        find /tmp -name "iptv_*" -mtime +1 -delete 2>/dev/null && echo "âœ… ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†" || echo "â„¹ï¸  æ— ä¸´æ—¶æ–‡ä»¶å¯æ¸…ç†"
        find /tmp/iptv_discovery -name "*.pcap" -mtime +1 -delete 2>/dev/null && echo "âœ… æŠ“åŒ…æ–‡ä»¶å·²æ¸…ç†" || echo "â„¹ï¸  æ— æŠ“åŒ…æ–‡ä»¶å¯æ¸…ç†"
        echo "âœ… æ¸…ç†å®Œæˆ"
        ;;
        
    restart-services)
        echo "ğŸ”„ é‡å¯WebæœåŠ¡..."
        echo "========================================"
        /etc/init.d/uhttpd restart 2>&1
        echo "âœ… æœåŠ¡é‡å¯å®Œæˆ"
        ;;
        
    advanced-monitor)
        INTERFACE=$(echo "$QUERY_STRING" | sed -n 's/.*interface=\([^&]*\).*/\1/p')
        DURATION=$(echo "$QUERY_STRING" | sed -n 's/.*duration=\([^&]*\).*/\1/p')
        INTERFACE=${INTERFACE:-eth1}
        DURATION=${DURATION:-180}
        
        echo "ğŸ¬ å¼€å§‹é«˜çº§ç›‘æ§"
        echo "ğŸ“¡ æ¥å£: $INTERFACE"
        echo "â±ï¸  æ—¶é•¿: $DURATION ç§’"
        echo "========================================"
        
        # è®¾ç½®ä¸´æ—¶ç¯å¢ƒå˜é‡
        export MONITOR_INTERFACE="$INTERFACE"
        export MONITOR_DURATION="$DURATION"
        
        /usr/bin/iptv-monitor
        ;;
        
    *)
        echo "âŒ é”™è¯¯: æœªçŸ¥åŠ¨ä½œ '$ACTION'"
        echo "ğŸ’¡ ä½¿ç”¨ä¸å¸¦å‚æ•°è®¿é—®æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
        ;;
esac

log "å‘½ä»¤æ‰§è¡Œå®Œæˆ: $ACTION"
EOF

    chmod +x "$CGI_DIR/iptv-web"
    log "âœ… CGIè„šæœ¬å®‰è£…å®Œæˆ"
}

# åˆ›å»ºé…ç½®æ–‡ä»¶
create_configuration() {
    step "åˆ›å»ºé…ç½®æ–‡ä»¶..."
    
    cat > "$CONFIG_DIR/config" << 'EOF'
# IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿé…ç½®æ–‡ä»¶
# ç‰ˆæœ¬: 5.0
# ç”Ÿæˆæ—¶é—´: $(date)

# åŸºæœ¬è®¾ç½®
MONITOR_INTERFACE=eth1
MONITOR_DURATION=180
CAPTURE_PACKETS=500

# å®æ—¶ç›‘æ§
REALTIME_DURATION=3600
ALERT_THRESHOLD=10

# é«˜çº§åŠŸèƒ½
AUTO_GENERATE_CONFIG=1
ENABLE_HISTORY_ANALYSIS=1

# ç½‘ç»œè®¾ç½®
TCPDUMP_FILTER=udp and portrange 10000-65000
IGNORE_PORTS=53,67,68,123,161,162,514
EOF

    log "âœ… é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
}

# é…ç½®uHTTPdæœåŠ¡å™¨
configure_uhttpd() {
    step "é…ç½®WebæœåŠ¡å™¨..."
    
    # æ£€æŸ¥uHTTPdæ˜¯å¦è¿è¡Œ
    if ! pgrep uhttpd >/dev/null; then
        log "å¯åŠ¨uHTTPdæœåŠ¡..."
        /etc/init.d/uhttpd start 2>/dev/null || warn "uHTTPdå¯åŠ¨å¤±è´¥"
        /etc/init.d/uhttpd enable 2>/dev/null || warn "uHTTPdå¯ç”¨å¤±è´¥"
    fi
    
    # ç¡®ä¿é˜²ç«å¢™å…è®¸è®¿é—®
    if command -v iptables >/dev/null 2>&1; then
        iptables -I input_rule -p tcp --dport 80 -j ACCEPT 2>/dev/null && \
        log "âœ… é˜²ç«å¢™è§„åˆ™å·²æ·»åŠ " || \
        warn "âš ï¸  é˜²ç«å¢™è§„åˆ™æ·»åŠ å¤±è´¥"
    fi
    
    log "âœ… WebæœåŠ¡å™¨é…ç½®å®Œæˆ"
}

# è®¾ç½®æ–‡ä»¶æƒé™
set_permissions() {
    step "è®¾ç½®æ–‡ä»¶æƒé™..."
    
    chmod +x "$CGI_DIR/iptv-web"
    chmod +x "$SCRIPT_DIR"/iptv-*
    chmod 755 "$WEB_DIR"
    
    log "âœ… æ–‡ä»¶æƒé™è®¾ç½®å®Œæˆ"
}

# éªŒè¯å®‰è£…
verify_installation() {
    step "éªŒè¯å®‰è£…..."
    
    echo ""
    echo "ğŸ” æ£€æŸ¥æ ¸å¿ƒç»„ä»¶:"
    for component in iptv-monitor iptv-analyze iptv-quicktest; do
        if [ -x "$SCRIPT_DIR/$component" ]; then
            echo "  âœ… $component"
        else
            echo "  âŒ $component"
        fi
    done
    
    echo ""
    echo "ğŸ” æ£€æŸ¥ç½‘é¡µæ–‡ä»¶:"
    for file in index.html; do
        if [ -f "$WEB_DIR/$file" ]; then
            echo "  âœ… $file"
        else
            echo "  âŒ $file"
        fi
    done
    
    echo ""
    echo "ğŸ” æ£€æŸ¥CGIè„šæœ¬:"
    if [ -x "$CGI_DIR/iptv-web" ]; then
        echo "  âœ… iptv-web"
    else
        echo "  âŒ iptv-web"
    fi
    
    echo ""
    echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€:"
    if pgrep uhttpd >/dev/null; then
        echo "  âœ… uHTTPdæœåŠ¡è¿è¡Œä¸­"
    else
        echo "  âŒ uHTTPdæœåŠ¡æœªè¿è¡Œ"
    fi
    
    log "âœ… å®‰è£…éªŒè¯å®Œæˆ"
}

# æ˜¾ç¤ºå®Œæˆä¿¡æ¯
show_completion() {
    # è·å–æœ¬åœ°IP
    LOCAL_IP=$(ip addr show br-lan 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    if [ -z "$LOCAL_IP" ]; then
        LOCAL_IP=$(ip addr show | grep "inet " | grep -v "127.0.0.1" | head -1 | awk '{print $2}' | cut -d/ -f1)
    fi
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘              ğŸ‰ å®‰è£…å®Œæˆï¼                  â•‘${NC}"
    echo -e "${GREEN}â•‘                                              â•‘${NC}"
    echo -e "${GREEN}â•‘        ğŸŒ è®¿é—®åœ°å€: http://$LOCAL_IP/iptv/   â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BLUE}ğŸ“‹ å¿«é€Ÿå¼€å§‹æŒ‡å—:${NC}"
    echo "  1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ä¸Šè¿°åœ°å€"
    echo "  2. ç‚¹å‡»'å¿«é€Ÿæµ‹è¯•'éªŒè¯ç³»ç»Ÿ"
    echo "  3. å¼€å§‹ç›‘æ§å‘ç°IPTVé¢‘é“"
    echo "  4. ç”Ÿæˆæ’­æ”¾åˆ—è¡¨å’Œé…ç½®"
    echo ""
    echo -e "${BLUE}ğŸ”§ å¸¸ç”¨å‘½ä»¤:${NC}"
    echo "  æ‰‹åŠ¨ç›‘æ§: iptv-monitor"
    echo "  åˆ†ææµé‡: iptv-analyze <æ–‡ä»¶>"
    echo "  ç³»ç»Ÿæµ‹è¯•: iptv-quicktest"
    echo "  ç”Ÿæˆé…ç½®: iptv-generate-config m3u"
    echo ""
    echo -e "${BLUE}ğŸ“ æ–‡ä»¶ä½ç½®:${NC}"
    echo "  ç½‘é¡µæ–‡ä»¶: $WEB_DIR/"
    echo "  é…ç½®æ–‡ä»¶: $CONFIG_DIR/config"
    echo "  æ—¥å¿—æ–‡ä»¶: $LOG_DIR/"
    echo "  è„šæœ¬æ–‡ä»¶: $SCRIPT_DIR/iptv-*"
    echo ""
    echo -e "${BLUE}ğŸ› ï¸  æ•…éšœæ’é™¤:${NC}"
    echo "  é‡å¯æœåŠ¡: /etc/init.d/uhttpd restart"
    echo "  æŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/web_interface.log"
    echo "  é‡æ–°å®‰è£…: å†æ¬¡è¿è¡Œæ­¤è„šæœ¬"
    echo ""
    echo -e "${GREEN}ğŸš€ å¼€å§‹äº«å—æ‚¨çš„IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿå§ï¼${NC}"
}

# ä¸»å®‰è£…å‡½æ•°
main() {
    show_banner
    
    # ç¡®è®¤å®‰è£…
    echo -n "å¼€å§‹å®‰è£…IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿï¼Ÿ(Y/n): "
    read -r choice
    case "$choice" in
        n|N)
            log "å®‰è£…å·²å–æ¶ˆ"
            exit 0
            ;;
        *)
            log "å¼€å§‹å®‰è£…..."
            ;;
    esac
    
    # æ‰§è¡Œå®‰è£…æ­¥éª¤
    check_system
    check_root
    check_network
    install_dependencies
    create_directories
    install_core_scripts
    install_web_interface
    install_cgi_scripts
    create_configuration
    configure_uhttpd
    set_permissions
    verify_installation
    show_completion
    
    echo ""
    log "ğŸŠ å®‰è£…å®Œæˆï¼æ„Ÿè°¢ä½¿ç”¨IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿ"
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"

