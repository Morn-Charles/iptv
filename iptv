
## å¿«é€Ÿå¼€å§‹
1. è¿è¡Œå¿«é€Ÿæµ‹è¯•: `iptv-quicktest`
2. å¼€å§‹ç›‘æ§: `iptv-monitor`
3. è®¿é—®Webç•Œé¢: http://ä½ çš„è·¯ç”±å™¨IP/iptv/

## æ•…éšœæ’é™¤
æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶: `tail -f /var/log/iptv_discovery/monitor.log`
é‡å¯WebæœåŠ¡: `/etc/init.d/uhttpd restart`
EOF

    log "âœ… é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
}

# é…ç½®uHTTPdæœåŠ¡å™¨
configure_uhttpd() {
    step "é…ç½®WebæœåŠ¡å™¨..."
    
    # æ£€æŸ¥uHTTPdé…ç½®
    if [ ! -f /etc/config/uhttpd ]; then
        warn "uHTTPdé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºåŸºæœ¬é…ç½®..."
        
        cat > /etc/config/uhttpd << 'EOF'
config uhttpd 'main'
    list listen_http '0.0.0.0:80'
    option home '/www'
    option rfc1918_filter '0'
    option max_requests '3'
    option max_connections '100'
    option cert '/etc/uhttpd.crt'
    option key '/etc/uhttpd.key'
    option cgi_prefix '/cgi-bin'
    option script_timeout '60'
    option network_timeout '30'
    option http_keepalive '20'
    option tcp_keepalive '1'
    option lua_prefix '/lua'
    option lua_handler '/usr/lib/uhttpd_lua.so'
EOF
    fi
    
    # å¯åŠ¨uHTTPdæœåŠ¡
    if /etc/init.d/uhttpd enabled 2>/dev/null; then
        log "é‡å¯uHTTPdæœåŠ¡..."
        if /etc/init.d/uhttpd restart 2>/dev/null; then
            log "âœ… uHTTPdæœåŠ¡é‡å¯æˆåŠŸ"
        else
            warn "uHTTPdæœåŠ¡é‡å¯å¤±è´¥ï¼Œå°è¯•å¯åŠ¨..."
            /etc/init.d/uhttpd start 2>/dev/null || warn "uHTTPdå¯åŠ¨å¤±è´¥"
        fi
    else
        log "å¯åŠ¨uHTTPdæœåŠ¡..."
        /etc/init.d/uhttpd start 2>/dev/null || warn "uHTTPdå¯åŠ¨å¤±è´¥"
        /etc/init.d/uhttpd enable 2>/dev/null || warn "uHTTPdå¯ç”¨å¤±è´¥"
    fi
    
    # ç¡®ä¿é˜²ç«å¢™å…è®¸è®¿é—®
    if command -v iptables >/dev/null 2>&1; then
        if ! iptables -L INPUT 2>/dev/null | grep -q "tcp dpt:80"; then
            iptables -I INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null && \
            log "âœ… é˜²ç«å¢™è§„åˆ™å·²æ·»åŠ " || \
            warn "âš ï¸  é˜²ç«å¢™è§„åˆ™æ·»åŠ å¤±è´¥"
        else
            log "âœ… é˜²ç«å¢™è§„åˆ™å·²å­˜åœ¨"
        fi
    fi
    
    log "âœ… WebæœåŠ¡å™¨é…ç½®å®Œæˆ"
}

# è®¾ç½®æ–‡ä»¶æƒé™
set_permissions() {
    step "è®¾ç½®æ–‡ä»¶æƒé™..."
    
    # è®¾ç½®è„šæœ¬æƒé™
    chmod +x "$CGI_DIR/iptv-web" 2>/dev/null && log "âœ… CGIè„šæœ¬æƒé™è®¾ç½®æˆåŠŸ" || warn "CGIè„šæœ¬æƒé™è®¾ç½®å¤±è´¥"
    chmod +x "$SCRIPT_DIR"/iptv-* 2>/dev/null && log "âœ… æ ¸å¿ƒè„šæœ¬æƒé™è®¾ç½®æˆåŠŸ" || warn "æ ¸å¿ƒè„šæœ¬æƒé™è®¾ç½®å¤±è´¥"
    
    # è®¾ç½®ç›®å½•æƒé™
    chmod 755 "$WEB_DIR" 2>/dev/null && log "âœ… ç½‘é¡µç›®å½•æƒé™è®¾ç½®æˆåŠŸ" || warn "ç½‘é¡µç›®å½•æƒé™è®¾ç½®å¤±è´¥"
    chmod 755 "$LOG_DIR" 2>/dev/null && log "âœ… æ—¥å¿—ç›®å½•æƒé™è®¾ç½®æˆåŠŸ" || warn "æ—¥å¿—ç›®å½•æƒé™è®¾ç½®å¤±è´¥"
    
    log "âœ… æ–‡ä»¶æƒé™è®¾ç½®å®Œæˆ"
}

# åˆ›å»ºç³»ç»ŸæœåŠ¡
create_system_service() {
    step "åˆ›å»ºç³»ç»ŸæœåŠ¡..."
    
    # åˆ›å»ºå¯åŠ¨è„šæœ¬
    cat > /etc/init.d/iptv-discovery << 'EOF'
#!/bin/sh /etc/rc.common

START=99
STOP=10

USE_PROCD=1

start_service() {
    procd_open_instance
    procd_set_param command /bin/true
    procd_close_instance
    
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    mkdir -p /var/log/iptv_discovery
    mkdir -p /tmp/iptv_discovery
    
    echo "IPTV Discovery System initialized"
}

stop_service() {
    # åœæ­¢ç›‘æ§è¿›ç¨‹
    pkill -f "iptv-monitor"
    pkill -f "iptv-realtime"
    echo "IPTV Discovery System stopped"
}
EOF

    chmod +x /etc/init.d/iptv-discovery 2>/dev/null && \
    /etc/init.d/iptv-discovery enable 2>/dev/null && \
    log "âœ… ç³»ç»ŸæœåŠ¡åˆ›å»ºæˆåŠŸ" || \
    warn "âš ï¸  ç³»ç»ŸæœåŠ¡åˆ›å»ºå¤±è´¥"
}

# éªŒè¯å®‰è£…
verify_installation() {
    step "éªŒè¯å®‰è£…..."
    
    echo ""
    echo "ğŸ” æ£€æŸ¥æ ¸å¿ƒç»„ä»¶:"
    local core_components=("iptv-monitor" "iptv-quicktest" "iptv-generate-config")
    for component in "${core_components[@]}"; do
        if [ -x "$SCRIPT_DIR/$component" ]; then
            echo "  âœ… $component"
        else
            echo "  âŒ $component"
        fi
    done
    
    echo ""
    echo "ğŸ” æ£€æŸ¥ç½‘é¡µæ–‡ä»¶:"
    if [ -f "$WEB_DIR/index.html" ]; then
        echo "  âœ… ç½‘é¡µç•Œé¢"
    else
        echo "  âŒ ç½‘é¡µç•Œé¢"
    fi
    
    echo ""
    echo "ğŸ” æ£€æŸ¥CGIè„šæœ¬:"
    if [ -x "$CGI_DIR/iptv-web" ]; then
        echo "  âœ… CGIè„šæœ¬"
    else
        echo "  âŒ CGIè„šæœ¬"
    fi
    
    echo ""
    echo "ğŸ” æ£€æŸ¥é…ç½®æ–‡ä»¶:"
    if [ -f "$CONFIG_DIR/config" ]; then
        echo "  âœ… é…ç½®æ–‡ä»¶"
    else
        echo "  âŒ é…ç½®æ–‡ä»¶"
    fi
    
    echo ""
    echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€:"
    if pgrep uhttpd >/dev/null; then
        echo "  âœ… uHTTPdæœåŠ¡è¿è¡Œä¸­"
    else
        echo "  âŒ uHTTPdæœåŠ¡æœªè¿è¡Œ"
    fi
    
    log "âœ… å®‰è£…éªŒè¯å®Œæˆ"
}

# æ˜¾ç¤ºå®Œæˆä¿¡æ¯
show_completion() {
    # è·å–æœ¬åœ°IP
    LOCAL_IP=$(ip addr show br-lan 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    if [ -z "$LOCAL_IP" ]; then
        LOCAL_IP=$(ip addr show | grep "inet " | grep -v "127.0.0.1" | head -1 | awk '{print $2}' | cut -d/ -f1)
    fi
    
    # å¦‚æœè¿˜æ˜¯æ— æ³•è·å–IPï¼Œä½¿ç”¨é»˜è®¤å€¼
    LOCAL_IP=${LOCAL_IP:-"ä½ çš„è·¯ç”±å™¨IP"}
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘              ğŸ‰ å®‰è£…å®Œæˆï¼                  â•‘${NC}"
    echo -e "${GREEN}â•‘                 v6.0 ä¼˜åŒ–ç‰ˆ                 â•‘${NC}"
    echo -e "${GREEN}â•‘                                              â•‘${NC}"
    echo -e "${GREEN}â•‘        ğŸŒ è®¿é—®åœ°å€: http://$LOCAL_IP/iptv/   â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BLUE}ğŸ“‹ å¿«é€Ÿå¼€å§‹æŒ‡å—:${NC}"
    echo "  1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ä¸Šè¿°åœ°å€"
    echo "  2. ç‚¹å‡»'å¿«é€Ÿæµ‹è¯•'éªŒè¯ç³»ç»ŸçŠ¶æ€"
    echo "  3. åœ¨'æµé‡ç›‘æ§'ä¸­å¼€å§‹å‘ç°IPTVé¢‘é“"
    echo "  4. åœ¨'é…ç½®ç”Ÿæˆ'ä¸­åˆ›å»ºæ’­æ”¾åˆ—è¡¨å’Œé…ç½®"
    echo ""
    echo -e "${BLUE}ğŸ”§ å¸¸ç”¨å‘½ä»¤:${NC}"
    echo "  ç³»ç»Ÿæµ‹è¯•: iptv-quicktest"
    echo "  å¼€å§‹ç›‘æ§: iptv-monitor"
    echo "  åˆ†ææµé‡: iptv-analyze <æ–‡ä»¶>"
    echo "  ç”Ÿæˆé…ç½®: iptv-generate-config all"
    echo ""
    echo -e "${BLUE}ğŸ“ æ–‡ä»¶ä½ç½®:${NC}"
    echo "  ç½‘é¡µæ–‡ä»¶: $WEB_DIR/"
    echo "  é…ç½®æ–‡ä»¶: $CONFIG_DIR/config"
    echo "  æ—¥å¿—æ–‡ä»¶: $LOG_DIR/"
    echo "  è„šæœ¬æ–‡ä»¶: $SCRIPT_DIR/iptv-*"
    echo ""
    echo -e "${BLUE}ğŸ› ï¸  æ•…éšœæ’é™¤:${NC}"
    echo "  é‡å¯æœåŠ¡: /etc/init.d/uhttpd restart"
    echo "  æŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/web_interface.log"
    echo "  é‡æ–°å®‰è£…: å†æ¬¡è¿è¡Œæ­¤è„šæœ¬"
    echo ""
    echo -e "${BLUE}ğŸ“– æ–‡æ¡£å¸®åŠ©:${NC}"
    echo "  æŸ¥çœ‹æ–‡æ¡£: cat $CONFIG_DIR/README.md"
    echo "  è·å–å¸®åŠ©: è®¿é—®Webç•Œé¢çš„å¸®åŠ©éƒ¨åˆ†"
    echo ""
    echo -e "${GREEN}ğŸš€ å¼€å§‹äº«å—æ‚¨çš„IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿå§ï¼${NC}"
}

# åˆ›å»ºå¸è½½è„šæœ¬
create_uninstall_script() {
    step "åˆ›å»ºå¸è½½è„šæœ¬..."
    
    cat > "$SCRIPT_DIR/iptv-uninstall" << 'EOF'
#!/bin/sh

# IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿå¸è½½è„šæœ¬

echo "ğŸ§¹ IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿå¸è½½ç¨‹åº"
echo "========================================"
echo "âš ï¸  è­¦å‘Š: è¿™å°†åˆ é™¤æ‰€æœ‰ç›¸å…³æ–‡ä»¶å’Œé…ç½®"
echo ""
echo -n "ç¡®å®šè¦ç»§ç»­å¸è½½å—ï¼Ÿ(y/N): "
read -r choice

if [ "$choice" != "y" ] && [ "$choice" != "Y" ]; then
    echo "å¸è½½å·²å–æ¶ˆ"
    exit 0
fi

echo ""
echo "å¼€å§‹å¸è½½..."

# åœæ­¢æœåŠ¡
echo "â¹ï¸  åœæ­¢æœåŠ¡..."
pkill -f "iptv-monitor"
pkill -f "iptv-realtime"

# åˆ é™¤æ–‡ä»¶
echo "ğŸ—‘ï¸  åˆ é™¤æ–‡ä»¶..."
rm -rf /www/iptv
rm -f /www/cgi-bin/iptv-web
rm -f /usr/bin/iptv-*
rm -rf /etc/iptv_discovery

# ä¿ç•™æ—¥å¿—ç›®å½•ä½†æ¸…ç†å†…å®¹
if [ -d "/var/log/iptv_discovery" ]; then
    echo "ğŸ“ æ¸…ç†æ—¥å¿—æ–‡ä»¶..."
    rm -f /var/log/iptv_discovery/*
fi

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
rm -rf /tmp/iptv_discovery
rm -f /tmp/iptv_streams_*.txt
rm -f /tmp/iptv_playlist_*.m3u
rm -f /tmp/iptv_configs_*

echo ""
echo "âœ… å¸è½½å®Œæˆ!"
echo ""
echo "æ³¨æ„: ä»¥ä¸‹é¡¹ç›®æœªè¢«åˆ é™¤:"
echo "  - æ—¥å¿—ç›®å½•: /var/log/iptv_discovery/"
echo "  - ç”¨æˆ·æ•°æ®: è¯·æ‰‹åŠ¨å¤‡ä»½é‡è¦æ•°æ®"
echo ""
echo "æ„Ÿè°¢ä½¿ç”¨IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿ!"
EOF

    chmod +x "$SCRIPT_DIR/iptv-uninstall"
    log "âœ… å¸è½½è„šæœ¬åˆ›å»ºå®Œæˆ"
}

# æ‰§è¡Œå®‰è£…åæµ‹è¯•
post_install_test() {
    step "æ‰§è¡Œå®‰è£…åæµ‹è¯•..."
    
    echo ""
    echo "ğŸ§ª è¿è¡Œå¿«é€Ÿç³»ç»Ÿæµ‹è¯•..."
    if /usr/bin/iptv-quicktest > /tmp/iptv_install_test.log 2>&1; then
        log "âœ… å®‰è£…åæµ‹è¯•é€šè¿‡"
        echo "ğŸ“ æµ‹è¯•æ—¥å¿—: /tmp/iptv_install_test.log"
    else
        warn "âš ï¸  å®‰è£…åæµ‹è¯•å‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—: /tmp/iptv_install_test.log"
    fi
}

# ä¸»å®‰è£…å‡½æ•°
main() {
    show_banner
    
    # ç¡®è®¤å®‰è£…
    echo -n "å¼€å§‹å®‰è£…IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿ v6.0ï¼Ÿ(Y/n): "
    read -r choice
    case "$choice" in
        n|N)
            log "å®‰è£…å·²å–æ¶ˆ"
            exit 0
            ;;
        *)
            log "å¼€å§‹å®‰è£…..."
            ;;
    esac
    
    # æ‰§è¡Œå®‰è£…æ­¥éª¤
    check_system
    check_root
    check_network
    install_dependencies
    create_directories
    install_core_scripts
    install_web_interface
    install_cgi_scripts
    create_configuration
    configure_uhttpd
    set_permissions
    create_system_service
    create_uninstall_script
    verify_installation
    post_install_test
    show_completion
    
    echo ""
    log "ğŸŠ å®‰è£…å®Œæˆï¼æ„Ÿè°¢ä½¿ç”¨IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿ v6.0"
    echo ""
    log "ğŸ’¡ æç¤º: å¦‚éœ€å¸è½½ï¼Œè¯·è¿è¡Œ: iptv-uninstall"
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"
