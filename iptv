#!/bin/sh

# ==================================================
# IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿ - ç½‘é¡µç•Œé¢ç‰ˆ
# ç‰ˆæœ¬: 4.0
# åŠŸèƒ½: æä¾›Webç•Œé¢ç®¡ç†æ‰€æœ‰IPTVå‘ç°åŠŸèƒ½
# ==================================================

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# é…ç½®å˜é‡
WEB_DIR="/www/iptv"
CGI_DIR="/www/cgi-bin/iptv"
CONFIG_DIR="/etc/iptv_discovery"
LOG_DIR="/var/log/iptv_discovery"
BACKUP_DIR="/etc/iptv_discovery/backups"

# æ—¥å¿—å‡½æ•°
log() { echo -e "${GREEN}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') $1"; }
error() { echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') $1"; exit 1; }
step() { echo -e "${BLUE}[STEP]${NC} $1"; }

# æ˜¾ç¤ºæ¨ªå¹…
show_banner() {
    echo -e "${BLUE}"
    echo "================================================"
    echo "      IPTV è‡ªåŠ¨å‘ç°ç³»ç»Ÿ - ç½‘é¡µç•Œé¢ç‰ˆ"
    echo "                  ç‰ˆæœ¬ 4.0"
    echo "================================================"
    echo -e "${NC}"
    echo "åŠŸèƒ½ç‰¹æ€§:"
    echo "  âœ“ å®Œæ•´çš„Webç®¡ç†ç•Œé¢"
    echo "  âœ“ å®æ—¶ç›‘æ§ä»ªè¡¨æ¿"
    echo "  âœ“ é¢‘é“ç®¡ç†å’Œæ’­æ”¾åˆ—è¡¨ç”Ÿæˆ"
    echo "  âœ“ ç½‘ç»œè´¨é‡ç›‘æ§"
    echo "  âœ“ å†å²æ•°æ®å›¾è¡¨"
    echo "  âœ“ ç§»åŠ¨è®¾å¤‡å‹å¥½"
    echo ""
}

# æ£€æŸ¥ç³»ç»Ÿ
check_system() {
    step "æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ..."
    
    if [ ! -f /etc/openwrt_release ]; then
        warn "è¿™ä¸ªè„šæœ¬ä¸“ä¸º OpenWrt ç³»ç»Ÿè®¾è®¡"
        echo -n "æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ(y/N): "
        read -r choice
        if [ "$choice" != "y" ] && [ "$choice" != "Y" ]; then
            exit 1
        fi
    fi
    
    if [ -f /etc/openwrt_release ]; then
        DISTRIB_DESCRIPTION=$(grep 'DISTRIB_DESCRIPTION' /etc/openwrt_release | cut -d'=' -f2 | tr -d '"')
        log "æ£€æµ‹åˆ° OpenWrt: $DISTRIB_DESCRIPTION"
    fi
    
    # æ£€æŸ¥ uHTTPd
    if [ ! -f /etc/config/uhttpd ]; then
        warn "æœªæ£€æµ‹åˆ° uHTTPdï¼Œç½‘é¡µç•Œé¢å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ"
    fi
}

# æ£€æŸ¥ root æƒé™
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        error "è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬"
    fi
    log "æƒé™æ£€æŸ¥é€šè¿‡"
}

# å®‰è£…ä¾èµ–
install_dependencies() {
    step "å®‰è£…ç³»ç»Ÿä¾èµ–..."
    
    # æ›´æ–°åŒ…åˆ—è¡¨
    log "æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
    opkg update || warn "åŒ…åˆ—è¡¨æ›´æ–°å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
    
    # æ£€æŸ¥å¹¶å®‰è£…å¿…è¦è½¯ä»¶åŒ…
    local packages="tcpdump curl uhttpd uhttpd-mod-lua"
    for pkg in $packages; do
        if opkg list-installed | grep -q "^$pkg "; then
            log "$pkg å·²å®‰è£…"
        else
            log "å®‰è£… $pkg..."
            if opkg install "$pkg"; then
                log "$pkg å®‰è£…æˆåŠŸ"
            else
                warn "å®‰è£… $pkg å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å®‰è£…: opkg install $pkg"
            fi
        fi
    done
}

# åˆ›å»ºç›®å½•ç»“æ„
create_directories() {
    step "åˆ›å»ºç›®å½•ç»“æ„..."
    
    for dir in "$WEB_DIR" "$CGI_DIR" "$CONFIG_DIR" "$LOG_DIR" "$BACKUP_DIR" "/tmp/iptv_discovery"; do
        if mkdir -p "$dir"; then
            log "åˆ›å»ºç›®å½•: $dir"
        else
            error "åˆ›å»ºç›®å½•å¤±è´¥: $dir"
        fi
    done
}

# éƒ¨ç½²ç½‘é¡µæ–‡ä»¶
deploy_web_files() {
    step "éƒ¨ç½²ç½‘é¡µæ–‡ä»¶..."
    
    # ä¸»é¡µé¢
    cat > "$WEB_DIR/index.html" << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV è‡ªåŠ¨å‘ç°ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: var(--secondary);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .nav {
            background: var(--primary);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav button {
            background: none;
            border: none;
            color: white;
            padding: 15px 25px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 16px;
        }
        
        .nav button:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .nav button.active {
            background: rgba(255,255,255,0.2);
        }
        
        .content {
            padding: 30px;
            min-height: 500px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .card {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .status-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .status-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .log-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .stream-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .stream-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .progress {
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 10px 0;
        }
        
        .progress-bar {
            background: var(--primary);
            height: 100%;
            transition: width 0.3s;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .nav button {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ IPTV è‡ªåŠ¨å‘ç°ç³»ç»Ÿ</h1>
            <p>æ™ºèƒ½ç›‘æ§ã€åˆ†æå’Œé…ç½®æ‚¨çš„IPTVç½‘ç»œ</p>
        </div>
        
        <div class="nav">
            <button class="nav-btn active" data-tab="dashboard">ä»ªè¡¨æ¿</button>
            <button class="nav-btn" data-tab="monitor">æµé‡ç›‘æ§</button>
            <button class="nav-btn" data-tab="channels">é¢‘é“ç®¡ç†</button>
            <button class="nav-btn" data-tab="config">é…ç½®ç”Ÿæˆ</button>
            <button class="nav-btn" data-tab="network">ç½‘ç»œè¯Šæ–­</button>
            <button class="nav-btn" data-tab="history">å†å²åˆ†æ</button>
        </div>
        
        <div class="content">
            <!-- ä»ªè¡¨æ¿ -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h3>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <div>å‘ç°çš„é¢‘é“</div>
                            <div class="status-value" id="channels-count">0</div>
                            <div>å½“å‰æ´»è·ƒ</div>
                        </div>
                        <div class="status-item">
                            <div>ç›‘æ§çŠ¶æ€</div>
                            <div class="status-value" id="monitor-status">ç¦»çº¿</div>
                            <div>å®æ—¶çŠ¶æ€</div>
                        </div>
                        <div class="status-item">
                            <div>ç½‘ç»œæ¥å£</div>
                            <div class="status-value" id="interface-status">æœªçŸ¥</div>
                            <div>è¿æ¥çŠ¶æ€</div>
                        </div>
                        <div class="status-item">
                            <div>å­˜å‚¨ä½¿ç”¨</div>
                            <div class="status-value" id="storage-usage">0%</div>
                            <div>ç³»ç»Ÿèµ„æº</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
                    <button class="btn btn-success" onclick="startMonitor()">å¼€å§‹ç›‘æ§</button>
                    <button class="btn" onclick="quickTest()">å¿«é€Ÿæµ‹è¯•</button>
                    <button class="btn" onclick="generatePlaylist()">ç”Ÿæˆæ’­æ”¾åˆ—è¡¨</button>
                    <button class="btn btn-warning" onclick="stopMonitor()">åœæ­¢ç›‘æ§</button>
                </div>
                
                <div class="card">
                    <h3>ğŸ“ˆ å®æ—¶æ—¥å¿—</h3>
                    <div class="log-output" id="live-logs">
                        <div>ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æ“ä½œ...</div>
                    </div>
                </div>
            </div>
            
            <!-- æµé‡ç›‘æ§ -->
            <div id="monitor" class="tab-content">
                <div class="card">
                    <h3>ğŸ“¡ æµé‡ç›‘æ§è®¾ç½®</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label>ç›‘æ§æ¥å£:</label>
                            <select id="monitor-interface" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="eth1">eth1</option>
                                <option value="eth0">eth0</option>
                                <option value="br-lan">br-lan</option>
                                <option value="pppoe-wan">pppoe-wan</option>
                            </select>
                        </div>
                        <div>
                            <label>ç›‘æ§æ—¶é•¿ (ç§’):</label>
                            <input type="number" id="monitor-duration" value="180" style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd;">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="startAdvancedMonitor()">å¼€å§‹é«˜çº§ç›‘æ§</button>
                    <button class="btn" onclick="startRealtimeMonitor()">å¯åŠ¨å®æ—¶ç›‘æ§</button>
                </div>
                
                <div class="card">
                    <h3>ğŸ“Š ç›‘æ§çŠ¶æ€</h3>
                    <div id="monitor-progress" style="display: none;">
                        <div>ç›‘æ§è¿›åº¦:</div>
                        <div class="progress">
                            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="progress-text">å‡†å¤‡å¼€å§‹...</div>
                    </div>
                    <div class="log-output" id="monitor-logs">
                        ç›‘æ§æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
                    </div>
                </div>
            </div>
            
            <!-- é¢‘é“ç®¡ç† -->
            <div id="channels" class="tab-content">
                <div class="card">
                    <h3>ğŸ“º å‘ç°çš„é¢‘é“</h3>
                    <button class="btn" onclick="loadChannels()">åˆ·æ–°é¢‘é“åˆ—è¡¨</button>
                    <button class="btn btn-success" onclick="analyzeChannels()">åˆ†æé¢‘é“</button>
                    <div class="stream-list" id="channels-list">
                        <!-- é¢‘é“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ” é¢‘é“åˆ†æ</h3>
                    <div id="channel-analysis">
                        ç‚¹å‡»"åˆ†æé¢‘é“"æŒ‰é’®å¼€å§‹åˆ†æ...
                    </div>
                </div>
            </div>
            
            <!-- é…ç½®ç”Ÿæˆ -->
            <div id="config" class="tab-content">
                <div class="card">
                    <h3>âš™ï¸ é…ç½®ç”Ÿæˆå™¨</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button class="btn" onclick="generateConfig('m3u')">M3Uæ’­æ”¾åˆ—è¡¨</button>
                        <button class="btn" onclick="generateConfig('igmp')">IGMPé…ç½®</button>
                        <button class="btn" onclick="generateConfig('udpxy')">udpxyé…ç½®</button>
                        <button class="btn" onclick="generateConfig('xupnpd')">xupnpdé…ç½®</button>
                        <button class="btn btn-success" onclick="generateConfig('all')">ç”Ÿæˆæ‰€æœ‰é…ç½®</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“„ ç”Ÿæˆçš„é…ç½®</h3>
                    <div class="log-output" id="config-output">
                        é…ç½®è¾“å‡ºå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
                    </div>
                </div>
            </div>
            
            <!-- ç½‘ç»œè¯Šæ–­ -->
            <div id="network" class="tab-content">
                <div class="card">
                    <h3>ğŸŒ ç½‘ç»œè¯Šæ–­å·¥å…·</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button class="btn" onclick="networkTest('eth1')">æµ‹è¯•æ¥å£ eth1</button>
                        <button class="btn" onclick="networkTest('all')">å…¨é¢ç½‘ç»œæµ‹è¯•</button>
                        <button class="btn" onclick="testMulticast()">æµ‹è¯•ç»„æ’­æµ</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“Š è¯Šæ–­ç»“æœ</h3>
                    <div class="log-output" id="network-output">
                        ç½‘ç»œè¯Šæ–­ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
                    </div>
                </div>
            </div>
            
            <!-- å†å²åˆ†æ -->
            <div id="history" class="tab-content">
                <div class="card">
                    <h3>ğŸ“Š å†å²æ•°æ®åˆ†æ</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label>åˆ†æå¤©æ•°:</label>
                        <input type="number" id="history-days" value="7" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <button class="btn" onclick="analyzeHistory()">åˆ†æå†å²æ•°æ®</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“ˆ åˆ†ææŠ¥å‘Š</h3>
                    <div class="log-output" id="history-output">
                        å†å²åˆ†ææŠ¥å‘Šå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é€‰é¡¹å¡åˆ‡æ¢
        document.querySelectorAll('.nav-btn').forEach(button => {
            button.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                
                // æ·»åŠ activeç±»
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus() {
            fetch('/cgi-bin/iptv/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('channels-count').textContent = data.channels || 0;
                    document.getElementById('monitor-status').textContent = data.monitor_status || 'ç¦»çº¿';
                    document.getElementById('interface-status').textContent = data.interface || 'æœªçŸ¥';
                    document.getElementById('storage-usage').textContent = data.storage || '0%';
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // å¼€å§‹ç›‘æ§
        function startMonitor() {
            addLog('å¼€å§‹åŸºç¡€ç›‘æ§...');
            fetch('/cgi-bin/iptv/monitor')
                .then(response => response.text())
                .then(data => {
                    addLog('ç›‘æ§å®Œæˆ: ' + data);
                    updateSystemStatus();
                })
                .catch(error => {
                    addLog('ç›‘æ§é”™è¯¯: ' + error);
                });
        }

        // å¿«é€Ÿæµ‹è¯•
        function quickTest() {
            addLog('å¼€å§‹å¿«é€Ÿæµ‹è¯•...');
            fetch('/cgi-bin/iptv/quicktest')
                .then(response => response.text())
                .then(data => {
                    addLog('æµ‹è¯•ç»“æœ: ' + data);
                })
                .catch(error => {
                    addLog('æµ‹è¯•é”™è¯¯: ' + error);
                });
        }

        // ç”Ÿæˆæ’­æ”¾åˆ—è¡¨
        function generatePlaylist() {
            addLog('ç”Ÿæˆæ’­æ”¾åˆ—è¡¨...');
            fetch('/cgi-bin/iptv/generate?type=m3u')
                .then(response => response.text())
                .then(data => {
                    addLog('æ’­æ”¾åˆ—è¡¨ç”Ÿæˆå®Œæˆ: ' + data);
                })
                .catch(error => {
                    addLog('ç”Ÿæˆé”™è¯¯: ' + error);
                });
        }

        // åœæ­¢ç›‘æ§
        function stopMonitor() {
            addLog('åœæ­¢ç›‘æ§...');
            fetch('/cgi-bin/iptv/stop')
                .then(response => response.text())
                .then(data => {
                    addLog('ç›‘æ§å·²åœæ­¢: ' + data);
                    updateSystemStatus();
                })
                .catch(error => {
                    addLog('åœæ­¢é”™è¯¯: ' + error);
                });
        }

        // é«˜çº§ç›‘æ§
        function startAdvancedMonitor() {
            const interface = document.getElementById('monitor-interface').value;
            const duration = document.getElementById('monitor-duration').value;
            
            addLog(`å¼€å§‹é«˜çº§ç›‘æ§ - æ¥å£: ${interface}, æ—¶é•¿: ${duration}ç§’`);
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            document.getElementById('monitor-progress').style.display = 'block';
            simulateProgress(duration);
            
            fetch(`/cgi-bin/iptv/advanced-monitor?interface=${interface}&duration=${duration}`)
                .then(response => response.text())
                .then(data => {
                    addLog('é«˜çº§ç›‘æ§å®Œæˆ: ' + data);
                    document.getElementById('monitor-progress').style.display = 'none';
                    updateSystemStatus();
                })
                .catch(error => {
                    addLog('ç›‘æ§é”™è¯¯: ' + error);
                    document.getElementById('monitor-progress').style.display = 'none';
                });
        }

        // å®æ—¶ç›‘æ§
        function startRealtimeMonitor() {
            addLog('å¯åŠ¨å®æ—¶ç›‘æ§...');
            fetch('/cgi-bin/iptv/realtime')
                .then(response => response.text())
                .then(data => {
                    addLog('å®æ—¶ç›‘æ§å¯åŠ¨: ' + data);
                    updateSystemStatus();
                })
                .catch(error => {
                    addLog('å®æ—¶ç›‘æ§é”™è¯¯: ' + error);
                });
        }

        // åŠ è½½é¢‘é“
        function loadChannels() {
            addLog('åŠ è½½é¢‘é“åˆ—è¡¨...');
            fetch('/cgi-bin/iptv/channels')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('channels-list').innerHTML = data;
                    addLog('é¢‘é“åˆ—è¡¨åŠ è½½å®Œæˆ');
                })
                .catch(error => {
                    addLog('åŠ è½½é¢‘é“é”™è¯¯: ' + error);
                });
        }

        // åˆ†æé¢‘é“
        function analyzeChannels() {
            addLog('å¼€å§‹é¢‘é“åˆ†æ...');
            fetch('/cgi-bin/iptv/analyze-channels')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('channel-analysis').innerHTML = '<pre>' + data + '</pre>';
                    addLog('é¢‘é“åˆ†æå®Œæˆ');
                })
                .catch(error => {
                    addLog('åˆ†æé”™è¯¯: ' + error);
                });
        }

        // ç”Ÿæˆé…ç½®
        function generateConfig(type) {
            addLog(`ç”Ÿæˆ ${type} é…ç½®...`);
            fetch(`/cgi-bin/iptv/generate?type=${type}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('config-output').innerHTML = '<pre>' + data + '</pre>';
                    addLog(`${type} é…ç½®ç”Ÿæˆå®Œæˆ`);
                })
                .catch(error => {
                    addLog('é…ç½®ç”Ÿæˆé”™è¯¯: ' + error);
                });
        }

        // ç½‘ç»œæµ‹è¯•
        function networkTest(target) {
            addLog(`å¼€å§‹ç½‘ç»œæµ‹è¯•: ${target}`);
            fetch(`/cgi-bin/iptv/network-test?target=${target}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('network-output').innerHTML = '<pre>' + data + '</pre>';
                    addLog('ç½‘ç»œæµ‹è¯•å®Œæˆ');
                })
                .catch(error => {
                    addLog('ç½‘ç»œæµ‹è¯•é”™è¯¯: ' + error);
                });
        }

        // æµ‹è¯•ç»„æ’­æµ
        function testMulticast() {
            const stream = prompt('è¯·è¾“å…¥ç»„æ’­æµåœ°å€ (æ ¼å¼: 239.1.1.1:10000):');
            if (stream) {
                addLog(`æµ‹è¯•ç»„æ’­æµ: ${stream}`);
                fetch(`/cgi-bin/iptv/test-multicast?stream=${stream}`)
                    .then(response => response.text())
                    .then(data => {
                        document.getElementById('network-output').innerHTML = '<pre>' + data + '</pre>';
                        addLog('ç»„æ’­æµæµ‹è¯•å®Œæˆ');
                    })
                    .catch(error => {
                        addLog('ç»„æ’­æµæµ‹è¯•é”™è¯¯: ' + error);
                    });
            }
        }

        // å†å²åˆ†æ
        function analyzeHistory() {
            const days = document.getElementById('history-days').value;
            addLog(`åˆ†ææœ€è¿‘ ${days} å¤©çš„å†å²æ•°æ®...`);
            fetch(`/cgi-bin/iptv/history?days=${days}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('history-output').innerHTML = '<pre>' + data + '</pre>';
                    addLog('å†å²åˆ†æå®Œæˆ');
                })
                .catch(error => {
                    addLog('å†å²åˆ†æé”™è¯¯: ' + error);
                });
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logElement = document.getElementById('live-logs');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML = `<div>[${timestamp}] ${message}</div>` + logElement.innerHTML;
            
            // åŒæ—¶æ›´æ–°ç›‘æ§æ—¥å¿—
            const monitorLogs = document.getElementById('monitor-logs');
            if (monitorLogs) {
                monitorLogs.innerHTML = `<div>[${timestamp}] ${message}</div>` + monitorLogs.innerHTML;
            }
        }

        // æ¨¡æ‹Ÿè¿›åº¦æ¡
        function simulateProgress(duration) {
            let progress = 0;
            const interval = setInterval(() => {
                progress += 100 / (duration);
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-text').textContent = `è¿›åº¦: ${Math.round(progress)}%`;
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateSystemStatus();
            setInterval(updateSystemStatus, 10000); // æ¯10ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
            addLog('IPTVè‡ªåŠ¨å‘ç°ç³»ç»Ÿå·²å°±ç»ª');
        });
    </script>
</body>
</html>
EOF

    log "ä¸»é¡µé¢éƒ¨ç½²å®Œæˆ: $WEB_DIR/index.html"
    
    # åˆ›å»ºCGIè„šæœ¬ç›®å½•å’Œæ–‡ä»¶
    deploy_cgi_scripts
}

# éƒ¨ç½²CGIè„šæœ¬
deploy_cgi_scripts() {
    step "éƒ¨ç½²CGIè„šæœ¬..."
    
    # çŠ¶æ€æ£€æŸ¥è„šæœ¬
    cat > "$CGI_DIR/status" << 'EOF'
#!/bin/sh

echo "Content-type: application/json"
echo ""

# è·å–ç³»ç»ŸçŠ¶æ€
{
    # æ£€æŸ¥ç›‘æ§è¿›ç¨‹
    if pgrep -f "iptv-monitor" > /dev/null; then
        MONITOR_STATUS="è¿è¡Œä¸­"
    elif pgrep -f "iptv-realtime" > /dev/null; then
        MONITOR_STATUS="å®æ—¶ç›‘æ§"
    else
        MONITOR_STATUS="ç¦»çº¿"
    fi
    
    # è·å–å‘ç°çš„é¢‘é“æ•°é‡
    CHANNELS_COUNT=0
    RECENT_FILE=$(ls -t /tmp/iptv_streams_*.txt 2>/dev/null | head -1)
    if [ -n "$RECENT_FILE" ] && [ -f "$RECENT_FILE" ]; then
        CHANNELS_COUNT=$(grep -cE '^[0-9]+\s+[0-9]' "$RECENT_FILE" 2>/dev/null || echo 0)
    fi
    
    # è·å–ç½‘ç»œæ¥å£çŠ¶æ€
    INTERFACE=$(grep "^MONITOR_INTERFACE" /etc/iptv_discovery/config 2>/dev/null | cut -d= -f2 || echo "eth1")
    INTERFACE_STATUS="æ­£å¸¸"
    if ! ip link show "$INTERFACE" >/dev/null 2>&1; then
        INTERFACE_STATUS="ä¸å¯ç”¨"
    fi
    
    # è·å–å­˜å‚¨ä½¿ç”¨æƒ…å†µ
    STORAGE_USAGE=$(df -h /tmp | awk 'NR==2 {print $5}' | sed 's/%//')
    
    # è¾“å‡ºJSON
    cat << STATUS_JSON
{
    "channels": $CHANNELS_COUNT,
    "monitor_status": "$MONITOR_STATUS",
    "interface": "$INTERFACE",
    "interface_status": "$INTERFACE_STATUS",
    "storage": "$STORAGE_USAGE%"
}
STATUS_JSON
}
EOF

    # åŸºç¡€ç›‘æ§è„šæœ¬
    cat > "$CGI_DIR/monitor" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# å¯åŠ¨åŸºç¡€ç›‘æ§
{
    echo "å¼€å§‹IPTVæµé‡ç›‘æ§..."
    /usr/bin/iptv-monitor
    
    # æ£€æŸ¥ç»“æœ
    RECENT_FILE=$(ls -t /tmp/iptv_streams_*.txt 2>/dev/null | head -1)
    if [ -n "$RECENT_FILE" ] && [ -f "$RECENT_FILE" ]; then
        STREAM_COUNT=$(grep -cE '^[0-9]+\s+[0-9]' "$RECENT_FILE" 2>/dev/null || echo 0)
        echo "ç›‘æ§å®Œæˆï¼Œå‘ç° $STREAM_COUNT ä¸ªç»„æ’­æµ"
        echo "è¯¦ç»†ç»“æœ: $RECENT_FILE"
    else
        echo "ç›‘æ§å®Œæˆï¼Œä½†æœªå‘ç°ç»„æ’­æµ"
    fi
}
EOF

    # å¿«é€Ÿæµ‹è¯•è„šæœ¬
    cat > "$CGI_DIR/quicktest" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# æ‰§è¡Œå¿«é€Ÿæµ‹è¯•
{
    echo "=== IPTVç³»ç»Ÿå¿«é€Ÿæµ‹è¯• ==="
    echo "å¼€å§‹æ—¶é—´: $(date)"
    echo ""
    
    # æ£€æŸ¥æ ¸å¿ƒç»„ä»¶
    echo "1. ç»„ä»¶æ£€æŸ¥:"
    for cmd in iptv-monitor iptv-analyze iptv-realtime; do
        if command -v "$cmd" >/dev/null 2>&1; then
            echo "   âœ“ $cmd"
        else
            echo "   âœ— $cmd"
        fi
    done
    echo ""
    
    # æ£€æŸ¥ç½‘ç»œæ¥å£
    echo "2. ç½‘ç»œæ¥å£æ£€æŸ¥:"
    INTERFACE=$(grep "^MONITOR_INTERFACE" /etc/iptv_discovery/config 2>/dev/null | cut -d= -f2 || echo "eth1")
    if ip link show "$INTERFACE" >/dev/null 2>&1; then
        STATE=$(ip link show "$INTERFACE" | grep -o "state [A-Z]*" | cut -d' ' -f2)
        echo "   æ¥å£ $INTERFACE: $STATE"
    else
        echo "   æ¥å£ $INTERFACE: ä¸å­˜åœ¨"
    fi
    echo ""
    
    # å¿«é€Ÿæµé‡æµ‹è¯•
    echo "3. æµé‡æµ‹è¯•:"
    timeout 10 tcpdump -i "$INTERFACE" -c 5 udp 2>/dev/null && \
        echo "   æµé‡æ•è·: æ­£å¸¸" || \
        echo "   æµé‡æ•è·: æ— æµé‡"
    echo ""
    
    echo "æµ‹è¯•å®Œæˆ: $(date)"
}
EOF

    # åœæ­¢ç›‘æ§è„šæœ¬
    cat > "$CGI_DIR/stop" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# åœæ­¢æ‰€æœ‰ç›‘æ§è¿›ç¨‹
{
    echo "åœæ­¢IPTVç›‘æ§è¿›ç¨‹..."
    
    # åœæ­¢åŸºç¡€ç›‘æ§
    pkill -f "iptv-monitor"
    
    # åœæ­¢å®æ—¶ç›‘æ§
    pkill -f "iptv-realtime"
    
    # åœæ­¢tcpdumpè¿›ç¨‹
    pkill -f "tcpdump.*iptv"
    
    echo "æ‰€æœ‰ç›‘æ§è¿›ç¨‹å·²åœæ­¢"
    
    # éªŒè¯åœæ­¢
    if pgrep -f "iptv-monitor" > /dev/null || pgrep -f "iptv-realtime" > /dev/null; then
        echo "è­¦å‘Š: æŸäº›è¿›ç¨‹å¯èƒ½ä»åœ¨è¿è¡Œ"
    else
        echo "ç¡®è®¤: æ‰€æœ‰è¿›ç¨‹å·²åœæ­¢"
    fi
}
EOF

    # é«˜çº§ç›‘æ§è„šæœ¬
    cat > "$CGI_DIR/advanced-monitor" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# è·å–å‚æ•°
INTERFACE=$(echo "$QUERY_STRING" | grep -oE 'interface=[^&]+' | cut -d= -f2)
DURATION=$(echo "$QUERY_STRING" | grep -oE 'duration=[^&]+' | cut -d= -f2)

# è®¾ç½®é»˜è®¤å€¼
INTERFACE=${INTERFACE:-eth1}
DURATION=${DURATION:-180}

# æ‰§è¡Œé«˜çº§ç›‘æ§
{
    echo "å¼€å§‹é«˜çº§IPTVç›‘æ§"
    echo "æ¥å£: $INTERFACE"
    echo "æ—¶é•¿: $DURATION ç§’"
    echo ""
    
    # åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶
    TEMP_CONFIG="/tmp/iptv_web_config"
    cat > "$TEMP_CONFIG" << CONFIG_EOF
MONITOR_INTERFACE=$INTERFACE
MONITOR_DURATION=$DURATION
CAPTURE_PACKETS=1000
CONFIG_EOF
    
    # ä½¿ç”¨ä¸´æ—¶é…ç½®è¿è¡Œç›‘æ§
    export CONFIG_FILE="$TEMP_CONFIG"
    /usr/bin/iptv-monitor
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$TEMP_CONFIG"
    
    # æ˜¾ç¤ºç»“æœ
    RECENT_FILE=$(ls -t /tmp/iptv_streams_*.txt 2>/dev/null | head -1)
    if [ -n "$RECENT_FILE" ] && [ -f "$RECENT_FILE" ]; then
        STREAM_COUNT=$(grep -cE '^[0-9]+\s+[0-9]' "$RECENT_FILE" 2>/dev/null || echo 0)
        echo ""
        echo "ç›‘æ§å®Œæˆ!"
        echo "å‘ç° $STREAM_COUNT ä¸ªç»„æ’­æµ"
        echo "ç»“æœæ–‡ä»¶: $RECENT_FILE"
    else
        echo ""
        echo "ç›‘æ§å®Œæˆï¼Œä½†æœªå‘ç°ç»„æ’­æµ"
    fi
}
EOF

    # å®æ—¶ç›‘æ§è„šæœ¬
    cat > "$CGI_DIR/realtime" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# å¯åŠ¨å®æ—¶ç›‘æ§
{
    echo "å¯åŠ¨IPTVå®æ—¶ç›‘æ§å®ˆæŠ¤è¿›ç¨‹..."
    
    # æ£€æŸ¥æ˜¯å¦å·²åœ¨è¿è¡Œ
    if pgrep -f "iptv-realtime" > /dev/null; then
        echo "å®æ—¶ç›‘æ§å·²åœ¨è¿è¡Œ (PID: $(pgrep -f "iptv-realtime"))"
        exit 0
    fi
    
    # åå°å¯åŠ¨å®æ—¶ç›‘æ§
    /usr/bin/iptv-realtime &
    REALTIME_PID=$!
    
    echo "å®æ—¶ç›‘æ§å·²å¯åŠ¨ (PID: $REALTIME_PID)"
    echo "ç›‘æ§æ—¶é•¿: 1å°æ—¶"
    echo "çŠ¶æ€æ–‡ä»¶: /tmp/iptv_status.json"
    echo ""
    echo "å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹çŠ¶æ€:"
    echo "  cat /tmp/iptv_status.json"
    echo "  tail -f /var/log/iptv_discovery/realtime.log"
}
EOF

    # é¢‘é“åˆ—è¡¨è„šæœ¬
    cat > "$CGI_DIR/channels" << 'EOF'
#!/bin/sh

echo "Content-type: text/html"
echo ""

# æ˜¾ç¤ºå‘ç°çš„é¢‘é“åˆ—è¡¨
{
    RECENT_FILE=$(ls -t /tmp/iptv_streams_*.txt 2>/dev/null | head -1)
    
    if [ -z "$RECENT_FILE" ] || [ ! -f "$RECENT_FILE" ]; then
        echo "<div style='color: #666; text-align: center; padding: 20px;'>"
        echo "æœªå‘ç°é¢‘é“æ•°æ®<br>"
        echo "è¯·å…ˆè¿è¡Œç›‘æ§åŠŸèƒ½"
        echo "</div>"
        exit 0
    fi
    
    echo "<div style='margin-bottom: 15px;'>"
    echo "<strong>æ•°æ®æ–‡ä»¶:</strong> $(basename "$RECENT_FILE")"
    echo "</div>"
    
    # æ˜¾ç¤ºå‰50ä¸ªé¢‘é“
    grep -E '^[0-9]+\s+[0-9]' "$RECENT_FILE" | head -50 | while read line; do
        COUNT=$(echo "$line" | awk '{print $1}')
        STREAM=$(echo "$line" | awk '{print $2}')
        echo "<div class='stream-item'>"
        echo "<div style='display: flex; justify-content: space-between;'>"
        echo "<div><strong>$STREAM</strong></div>"
        echo "<div style='color: #27ae60;'>$COUNT åŒ…</div>"
        echo "</div>"
        echo "</div>"
    done
    
    TOTAL_STREAMS=$(grep -cE '^[0-9]+\s+[0-9]' "$RECENT_FILE" 2>/dev/null || echo 0)
    echo "<div style='margin-top: 15px; color: #666; text-align: center;'>"
    echo "å…±å‘ç° $TOTAL_STREAMS ä¸ªé¢‘é“ (æ˜¾ç¤ºå‰50ä¸ª)"
    echo "</div>"
}
EOF

    # é¢‘é“åˆ†æè„šæœ¬
    cat > "$CGI_DIR/analyze-channels" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# æ‰§è¡Œé¢‘é“åˆ†æ
{
    RECENT_FILE=$(ls -t /tmp/iptv_streams_*.txt 2>/dev/null | head -1)
    
    if [ -z "$RECENT_FILE" ] || [ ! -f "$RECENT_FILE" ]; then
        echo "é”™è¯¯: æœªæ‰¾åˆ°é¢‘é“æ•°æ®æ–‡ä»¶"
        echo "è¯·å…ˆè¿è¡Œç›‘æ§åŠŸèƒ½"
        exit 1
    fi
    
    echo "æ‰§è¡Œé¢‘é“åˆ†æ..."
    echo "è¾“å…¥æ–‡ä»¶: $RECENT_FILE"
    echo "========================================"
    echo ""
    
    /usr/bin/iptv-analyze-channels "$RECENT_FILE"
}
EOF

    # é…ç½®ç”Ÿæˆè„šæœ¬
    cat > "$CGI_DIR/generate" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# è·å–é…ç½®ç±»å‹
CONFIG_TYPE=$(echo "$QUERY_STRING" | grep -oE 'type=[^&]+' | cut -d= -f2)
CONFIG_TYPE=${CONFIG_TYPE:-m3u}

# ç”Ÿæˆé…ç½®
{
    case "$CONFIG_TYPE" in
        m3u)
            echo "ç”Ÿæˆ M3U æ’­æ”¾åˆ—è¡¨..."
            OUTPUT="/tmp/iptv_playlist_$(date +%Y%m%d_%H%M%S).m3u"
            /usr/bin/iptv-generate-config m3u "$OUTPUT"
            echo ""
            echo "æ’­æ”¾åˆ—è¡¨å·²ç”Ÿæˆ: $OUTPUT"
            echo ""
            cat "$OUTPUT"
            ;;
        igmp)
            echo "ç”Ÿæˆ IGMP é…ç½®..."
            OUTPUT="/tmp/igmp_config_$(date +%Y%m%d_%H%M%S).conf"
            /usr/bin/iptv-generate-config igmp "$OUTPUT"
            echo ""
            echo "IGMPé…ç½®å·²ç”Ÿæˆ: $OUTPUT"
            echo ""
            cat "$OUTPUT"
            ;;
        udpxy)
            echo "ç”Ÿæˆ udpxy é…ç½®..."
            OUTPUT="/tmp/udpxy_config_$(date +%Y%m%d_%H%M%S).conf"
            /usr/bin/iptv-generate-config udpxy "$OUTPUT"
            echo ""
            echo "udpxyé…ç½®å·²ç”Ÿæˆ: $OUTPUT"
            echo ""
            cat "$OUTPUT"
            ;;
        xupnpd)
            echo "ç”Ÿæˆ xupnpd é…ç½®..."
            OUTPUT="/tmp/xupnpd_config_$(date +%Y%m%d_%H%M%S).lua"
            /usr/bin/iptv-generate-config xupnpd "$OUTPUT"
            echo ""
            echo "xupnpdé…ç½®å·²ç”Ÿæˆ: $OUTPUT"
            echo ""
            cat "$OUTPUT"
            ;;
        all)
            echo "ç”Ÿæˆæ‰€æœ‰é…ç½®..."
            echo ""
            /usr/bin/iptv-generate-config all
            echo ""
            echo "æ‰€æœ‰é…ç½®å·²ç”Ÿæˆåˆ° /tmp/ ç›®å½•"
            ;;
        *)
            echo "é”™è¯¯: æœªçŸ¥çš„é…ç½®ç±»å‹: $CONFIG_TYPE"
            echo "å¯ç”¨çš„ç±»å‹: m3u, igmp, udpxy, xupnpd, all"
            ;;
    esac
}
EOF

    # ç½‘ç»œæµ‹è¯•è„šæœ¬
    cat > "$CGI_DIR/network-test" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# è·å–æµ‹è¯•ç›®æ ‡
TARGET=$(echo "$QUERY_STRING" | grep -oE 'target=[^&]+' | cut -d= -f2)
TARGET=${TARGET:-eth1}

# æ‰§è¡Œç½‘ç»œæµ‹è¯•
{
    case "$TARGET" in
        all)
            echo "æ‰§è¡Œå…¨é¢ç½‘ç»œæµ‹è¯•..."
            echo "================================"
            /usr/bin/iptv-network-test all
            ;;
        eth1|eth0|br-lan|pppoe-wan)
            echo "æµ‹è¯•ç½‘ç»œæ¥å£: $TARGET"
            echo "================================"
            /usr/bin/iptv-network-test "$TARGET"
            ;;
        *)
            echo "æµ‹è¯•ç›®æ ‡: $TARGET"
            echo "================================"
            /usr/bin/iptv-network-test "$TARGET"
            ;;
    esac
}
EOF

    # ç»„æ’­æµæµ‹è¯•è„šæœ¬
    cat > "$CGI_DIR/test-multicast" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# è·å–ç»„æ’­æµåœ°å€
STREAM=$(echo "$QUERY_STRING" | grep -oE 'stream=[^&]+' | cut -d= -f2)

if [ -z "$STREAM" ]; then
    echo "é”™è¯¯: æœªæŒ‡å®šç»„æ’­æµåœ°å€"
    echo "ç”¨æ³•: ?stream=239.1.1.1:10000"
    exit 1
fi

# æ‰§è¡Œç»„æ’­æµæµ‹è¯•
{
    echo "æµ‹è¯•ç»„æ’­æµ: $STREAM"
    echo "æµ‹è¯•æ—¶é•¿: 30ç§’"
    echo "================================"
    echo ""
    
    /usr/bin/iptv-network-test "$STREAM" 30
}
EOF

    # å†å²åˆ†æè„šæœ¬
    cat > "$CGI_DIR/history" << 'EOF'
#!/bin/sh

echo "Content-type: text/plain"
echo ""

# è·å–åˆ†æå¤©æ•°
DAYS=$(echo "$QUERY_STRING" | grep -oE 'days=[^&]+' | cut -d= -f2)
DAYS=${DAYS:-7}

# æ‰§è¡Œå†å²åˆ†æ
{
    echo "åˆ†ææœ€è¿‘ $DAYS å¤©çš„å†å²æ•°æ®"
    echo "ç”Ÿæˆæ—¶é—´: $(date)"
    echo "========================================"
    echo ""
    
    /usr/bin/iptv-analyze-history "$DAYS"
}
EOF

    # è®¾ç½®CGIè„šæœ¬æ‰§è¡Œæƒé™
    for script in status monitor quicktest stop advanced-monitor realtime channels analyze-channels generate network-test test-multicast history; do
        chmod +x "$CGI_DIR/$script"
        log "è®¾ç½®æ‰§è¡Œæƒé™: $CGI_DIR/$script"
    done
    
    log "CGIè„šæœ¬éƒ¨ç½²å®Œæˆ"
}

# é…ç½®uHTTPd
configure_uhttpd() {
    step "é…ç½®uHTTPdæœåŠ¡å™¨..."
    
    # æ£€æŸ¥uHTTPdé…ç½®
    if [ ! -f /etc/config/uhttpd ]; then
        warn "uHTTPdé…ç½®ä¸å­˜åœ¨ï¼Œåˆ›å»ºåŸºæœ¬é…ç½®..."
        
        cat > /etc/config/uhttpd << UHTTPD_EOF
config uhttpd 'main'
    option listen_http '0.0.0.0:80'
    option home '/www'
    option rfc1918_filter '0'
    option max_requests '3'
    option max_connections '100'
    option cert '/etc/uhttpd.crt'
    option key '/etc/uhttpd.key'
    option cgi_prefix '/cgi-bin'
    option script_timeout '60'
    option network_timeout '30'
    option http_keepalive '20'
    option tcp_keepalive '1'
    option lua_prefix '/lua'
    option lua_handler '/usr/lib/uhttpd_lua.so'

config uhttpd 'iptv'
    option listen_http '0.0.0.0:8080'
    option home '/www/iptv'
    option rfc1918_filter '0'
UHTTPD_EOF
    fi
    
    # é‡å¯uHTTPd
    if /etc/init.d/uhttpd enabled; then
        log "é‡å¯uHTTPdæœåŠ¡..."
        /etc/init.d/uhttpd restart
    else
        log "å¯åŠ¨uHTTPdæœåŠ¡..."
        /etc/init.d/uhttpd start
        /etc/init.d/uhttpd enable
    fi
    
    log "uHTTPdé…ç½®å®Œæˆ"
}

# å®‰è£…æ ¸å¿ƒåŠŸèƒ½
install_core_functions() {
    step "å®‰è£…æ ¸å¿ƒIPTVåŠŸèƒ½..."
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…æ ¸å¿ƒåŠŸèƒ½
    if [ ! -f "/usr/bin/iptv-monitor" ]; then
        warn "æ ¸å¿ƒIPTVåŠŸèƒ½æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
        
        # ä¸‹è½½å¹¶è¿è¡ŒåŸºç¡€å®‰è£…è„šæœ¬
        if command -v curl >/dev/null 2>&1; then
            curl -s https://raw.githubusercontent.com/example/iptv-discovery/main/install.sh | sh
        else
            warn "æ— æ³•ä¸‹è½½åŸºç¡€å®‰è£…è„šæœ¬ï¼Œè¯·æ‰‹åŠ¨å®‰è£…æ ¸å¿ƒåŠŸèƒ½"
        fi
    else
        log "æ ¸å¿ƒIPTVåŠŸèƒ½å·²å®‰è£…"
    fi
}

# éªŒè¯å®‰è£…
verify_installation() {
    step "éªŒè¯å®‰è£…..."
    
    # æ£€æŸ¥ç½‘é¡µæ–‡ä»¶
    local web_files="index.html"
    for file in $web_files; do
        if [ -f "$WEB_DIR/$file" ]; then
            log "âœ“ ç½‘é¡µæ–‡ä»¶: $file"
        else
            error "âœ— ç½‘é¡µæ–‡ä»¶ç¼ºå¤±: $file"
        fi
    done
    
    # æ£€æŸ¥CGIè„šæœ¬
    local cgi_scripts="status monitor quicktest stop advanced-monitor realtime channels analyze-channels generate network-test test-multicast history"
    for script in $cgi_scripts; do
        if [ -f "$CGI_DIR/$script" ] && [ -x "$CGI_DIR/$script" ]; then
            log "âœ“ CGIè„šæœ¬: $script"
        else
            warn "âœ— CGIè„šæœ¬ç¼ºå¤±: $script"
        fi
    done
    
    # æ£€æŸ¥uHTTPdçŠ¶æ€
    if pgrep uhttpd >/dev/null; then
        log "âœ“ uHTTPdæœåŠ¡è¿è¡Œä¸­"
    else
        warn "âœ— uHTTPdæœåŠ¡æœªè¿è¡Œ"
    fi
    
    log "ç½‘é¡µç•Œé¢éªŒè¯å®Œæˆ"
}

# æ˜¾ç¤ºå®‰è£…æ‘˜è¦
show_installation_summary() {
    # è·å–æœ¬åœ°IPåœ°å€
    LOCAL_IP=$(ip addr show br-lan 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    if [ -z "$LOCAL_IP" ]; then
        LOCAL_IP=$(ip addr show | grep "inet " | grep -v "127.0.0.1" | head -1 | awk '{print $2}' | cut -d/ -f1)
    fi
    
    echo ""
    echo -e "${GREEN}==========================================${NC}"
    echo -e "${GREEN}     IPTVç½‘é¡µç•Œé¢ç³»ç»Ÿå®‰è£…å®Œæˆ${NC}"
    echo -e "${GREEN}==========================================${NC}"
    echo ""
    echo -e "${BLUE}è®¿é—®ä¿¡æ¯:${NC}"
    echo "------------------------------------------"
    echo "ä¸»ç•Œé¢: http://$LOCAL_IP/iptv/"
    echo "å¤‡ç”¨åœ°å€: http://$LOCAL_IP:8080/"
    echo ""
    echo -e "${BLUE}åŠŸèƒ½ç‰¹æ€§:${NC}"
    echo "------------------------------------------"
    echo "âœ“ å®æ—¶ç›‘æ§ä»ªè¡¨æ¿"
    echo "âœ“ é¢‘é“ç®¡ç†å’Œåˆ†æ"
    echo "âœ“ é…ç½®è‡ªåŠ¨ç”Ÿæˆ"
    echo "âœ“ ç½‘ç»œè´¨é‡è¯Šæ–­"
    echo "âœ“ å†å²æ•°æ®åˆ†æ"
    echo "âœ“ ç§»åŠ¨è®¾å¤‡æ”¯æŒ"
    echo ""
    echo -e "${BLUE}æ–‡ä»¶ä½ç½®:${NC}"
    echo "------------------------------------------"
    echo "ç½‘é¡µæ–‡ä»¶: $WEB_DIR/"
    echo "CGIè„šæœ¬: $CGI_DIR/"
    echo "é…ç½®æ–‡ä»¶: $CONFIG_DIR/"
    echo "æ—¥å¿—æ–‡ä»¶: $LOG_DIR/"
    echo ""
    echo -e "${BLUE}ä¸‹ä¸€æ­¥æ“ä½œ:${NC}"
    echo "------------------------------------------"
    echo "1. æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://$LOCAL_IP/iptv/"
    echo "2. è¿è¡Œå¿«é€Ÿæµ‹è¯•éªŒè¯ç³»ç»Ÿ"
    echo "3. å¼€å§‹ç›‘æ§å‘ç°IPTVæµ"
    echo "4. ç”Ÿæˆæ’­æ”¾åˆ—è¡¨å’Œé…ç½®"
    echo ""
    echo -e "${BLUE}è·å–å¸®åŠ©:${NC}"
    echo "------------------------------------------"
    echo "æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€: è®¿é—®ç½‘é¡µä»ªè¡¨æ¿"
    echo "æŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/monitor.log"
    echo "é‡å¯æœåŠ¡: /etc/init.d/uhttpd restart"
    echo ""
    echo -e "${GREEN}==========================================${NC}"
}

# ä¸»å®‰è£…å‡½æ•°
main() {
    show_banner
    
    # æ‰§è¡Œå®‰è£…æ­¥éª¤
    check_system
    check_root
    install_dependencies
    create_directories
    deploy_web_files
    configure_uhttpd
    install_core_functions
    verify_installation
    show_installation_summary
    
    echo ""
    log "ç½‘é¡µç•Œé¢å®‰è£…å®Œæˆï¼"
    echo ""
    log "è¯·æ‰“å¼€æµè§ˆå™¨è®¿é—®ä¸Šè¿°åœ°å€å¼€å§‹ä½¿ç”¨"
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"
