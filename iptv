#!/bin/sh

# ==================================================
# IPTV网页界面 - 一键安装修复脚本
# 修复CGI连接问题
# ==================================================

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

show_banner() {
    echo -e "${GREEN}"
    echo "╔══════════════════════════════════════════╗"
    echo "║         IPTV网页界面修复工具            ║"
    echo "║              版本 1.0                  ║"
    echo "╚══════════════════════════════════════════╝"
    echo -e "${NC}"
}

check_system() {
    log "检查系统..."
    [ -f /etc/openwrt_release ] || warn "非OpenWrt系统，继续安装..."
}

download_and_install() {
    log "下载安装脚本..."
    
    # 创建临时安装脚本
    cat > /tmp/iptv-web-fix.sh << 'SCRIPT_EOF'
[将上面的完整修复脚本内容粘贴到这里]
SCRIPT_EOF

    chmod +x /tmp/iptv-web-fix.sh
    log "运行安装脚本..."
    /tmp/iptv-web-fix.sh
}

show_help() {
    LOCAL_IP=$(ip addr show br-lan 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    [ -z "$LOCAL_IP" ] && LOCAL_IP="你的路由器IP"
    
    echo ""
    echo -e "${GREEN}安装完成！${NC}"
    echo ""
    echo "访问地址: http://$LOCAL_IP/iptv/"
    echo ""
    echo -e "${YELLOW}如果仍然遇到问题，请尝试以下步骤:${NC}"
    echo "1. 重启uHTTPd: /etc/init.d/uhttpd restart"
    echo "2. 检查防火墙: iptables -I input_rule -p tcp --dport 80 -j ACCEPT"
    echo "3. 手动测试: wget -O- http://localhost/iptv/"
    echo ""
    echo -e "${GREEN}故障排除命令:${NC}"
    echo "查看服务状态: /etc/init.d/uhttpd status"
    echo "查看安装日志: tail -f /var/log/iptv_discovery/web_interface.log"
    echo "重新安装: rm -rf /www/iptv /www/cgi-bin/iptv-web && 重新运行此脚本"
}

main() {
    show_banner
    
    echo -n "开始安装修复？(Y/n): "
    read -r choice
    case "$choice" in
        n|N) exit 0 ;;
        *) ;;
    esac
    
    check_system
    download_and_install
    show_help
}

main "$@"
